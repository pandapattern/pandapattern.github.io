<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>设计师登录 / 资料 — 设计师站</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --accent:#0f766e; --muted:#6b7280; --card:#fff; --radius:12px; --shadow:0 6px 18px rgba(15,23,42,0.06); }
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto; background:#f3f6fb; margin:0; color:#0b1220; }
    .wrap{ max-width:820px; margin:32px auto; padding:18px; }
    .card{ background:var(--card); padding:18px; border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid rgba(2,6,23,0.04); }
    h1{ margin:0 0 8px 0; font-size:18px; }
    label{ display:block; font-weight:600; margin-top:12px; font-size:13px; }
    input, textarea{ width:100%; box-sizing:border-box; padding:10px; border-radius:8px; border:1px solid #e6e8eb; margin-top:6px; }
    .row{ display:flex; gap:8px; margin-top:12px; align-items:center; }
    button{ background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(15,118,110,0.12); }
    .muted{ color:var(--muted); font-size:13px; }
    .small{ font-size:13px; color:#666; }
    .avatarPreview{ width:96px; height:96px; border-radius:12px; object-fit:cover; background:#f0f2f4; display:inline-block; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
    .error{ color:#c53030; margin-top:8px; }
    .fileHint{ font-size:12px; color:var(--muted); margin-top:6px; }
    a.link{ color:var(--accent); text-decoration:none; }
    /* modal */
    .modal-backdrop{ position:fixed; left:0;top:0; right:0; bottom:0; background:rgba(2,6,23,0.45); display:flex; align-items:center; justify-content:center; z-index:2000; }
    .modal{ background:#fff; border-radius:10px; padding:16px; width:420px; box-shadow:0 12px 36px rgba(2,6,23,0.32); }
    .modal h3{ margin:0 0 8px 0; font-size:16px; }
    .muted-sm{ color:var(--muted); font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>设计师站 — 登录</h1>
      <div id="rightTopArea" class="muted">未登录</div>
    </div>

    <!-- AUTH CARD: 仅在未登录时显示 -->
    <div id="authCard" class="card" style="margin-bottom:12px;">
      <div style="display:flex; gap:12px; align-items:center;">
        <div>
          <div class="small muted">登录 / 注册</div>
        </div>
      </div>

      <label>邮箱</label>
      <input id="email" type="email" placeholder="designer@example.com" />

      <label>密码</label>
      <input id="password" type="password" placeholder="密码" />

      <div class="row">
        <button id="btnSignIn">登录</button>
        <button id="btnRegister" class="ghost">注册并发送验证邮件</button>
        <button id="btnForgotPassword" class="ghost">忘记密码</button>
        <button id="btnSignOut" class="ghost" style="display:none;">登出</button>
      </div>

      <div id="authMsg" class="small muted" style="margin-top:8px;"></div>
      <div id="authError" class="error"></div>
    </div>

    <!-- PROFILE CARD: 仅在已登录后且尚未填写设计师资料时显示 -->
    <div id="profileCard" class="card" style="display:none;">
      <h2 style="margin:0 0 8px 0;">设计师资料</h2>
      <div class="small muted">请填写你的公开资料，保存后将回到首页。</div>

      <label>用户名 (必填)</label>
      <input id="d_username" type="text" placeholder="显示名 / 用户名" />

      <label>头像（上传，可选）</label>
      <input id="d_avatar_file" type="file" accept="image/*" />
      <div style="margin-top:8px;">
        <img id="avatarPreview" class="avatarPreview" alt="avatar" src="" />
        <div class="fileHint">建议 512×512，最大 5MB。</div>
      </div>

      <label>工作室 / 店铺名</label>
      <input id="d_studio" type="text" placeholder="工作室 / 店铺名" />

      <label>品牌 Logo（上传，可选）</label>
      <input id="d_brandlogo_file" type="file" accept="image/*" />
      <div style="margin-top:8px;">
        <img id="brandPreview" class="avatarPreview" alt="brand logo" src="" />
        <div class="fileHint">横向 logo 建议 600×200，最大 5MB。</div>
      </div>

      <label>店铺网址（可选）</label>
      <input id="d_website" type="text" placeholder="https://yourshop.example" />

      <div class="row" style="margin-top:12px;">
        <button id="btnSaveProfile">保存资料并返回首页</button>
      </div>

      <div id="profileMsg" class="small muted" style="margin-top:8px;"></div>
      <div id="profileError" class="error"></div>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="forgotModal" style="display:none;">
    <div class="modal-backdrop" id="forgotBackdrop">
      <div class="modal">
        <h3>重置密码 — 发送邮件</h3>
        <div class="muted-sm">请输入注册时使用的邮箱。系统将向该邮箱发送重置链接。</div>
        <label style="margin-top:12px">邮箱</label>
        <input id="forgotEmail" type="email" placeholder="designer@example.com" />
        <div class="row" style="margin-top:12px;">
          <button id="forgotSendBtn">发送重置邮件</button>
          <button id="forgotCancelBtn" class="ghost">取消</button>
        </div>
        <div id="forgotMsg" class="muted-sm" style="margin-top:8px;"></div>
        <div id="forgotError" class="error"></div>
      </div>
    </div>
  </div>

  <!-- Reset Password (after clicking email link) Modal -->
  <div id="resetModal" style="display:none;">
    <div class="modal-backdrop" id="resetBackdrop">
      <div class="modal">
        <h3>设置新密码</h3>
        <div class="muted-sm">请在下面输入并确认新密码（密码将直接更新到你的账号）。</div>
        <label style="margin-top:12px">新密码</label>
        <input id="newPassword" type="password" placeholder="新密码" />
        <label style="margin-top:8px">确认新密码</label>
        <input id="confirmPassword" type="password" placeholder="再次输入新密码" />
        <div class="row" style="margin-top:12px;">
          <button id="resetSubmitBtn">设置新密码</button>
          <button id="resetCancelBtn" class="ghost">取消</button>
        </div>
        <div id="resetMsg" class="muted-sm" style="margin-top:8px;"></div>
        <div id="resetError" class="error"></div>
      </div>
    </div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ===== 配置 ===== */
const SUPABASE_URL = "https://fdxvtmgmmrpdkwhrbsfl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkeHZ0bWdtbXJwZGt3aHJic2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzY0NTUsImV4cCI6MjA3NDkxMjQ1NX0.iU-T3S8OzgGSXtbIf6D7WsMAaIXKNqZE8ooScS4udEk";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== DOM ===== */
const authCard = document.getElementById('authCard');
const profileCard = document.getElementById('profileCard');
const rightTopArea = document.getElementById('rightTopArea');

const emailEl = document.getElementById('email');
const passwordEl = document.getElementById('password');
const btnSignIn = document.getElementById('btnSignIn');
const btnRegister = document.getElementById('btnRegister');
const btnForgotPassword = document.getElementById('btnForgotPassword');
const btnSignOut = document.getElementById('btnSignOut');
const authMsg = document.getElementById('authMsg');
const authError = document.getElementById('authError');

const d_username = document.getElementById('d_username');
const d_avatar_file = document.getElementById('d_avatar_file');
const avatarPreview = document.getElementById('avatarPreview');
const d_studio = document.getElementById('d_studio');
const d_brandlogo_file = document.getElementById('d_brandlogo_file');
const brandPreview = document.getElementById('brandPreview');
const d_website = document.getElementById('d_website');
const btnSaveProfile = document.getElementById('btnSaveProfile');
const profileMsg = document.getElementById('profileMsg');
const profileError = document.getElementById('profileError');

const forgotModal = document.getElementById('forgotModal');
const forgotEmail = document.getElementById('forgotEmail');
const forgotSendBtn = document.getElementById('forgotSendBtn');
const forgotCancelBtn = document.getElementById('forgotCancelBtn');
const forgotMsg = document.getElementById('forgotMsg');
const forgotError = document.getElementById('forgotError');

const resetModal = document.getElementById('resetModal');
const newPassword = document.getElementById('newPassword');
const confirmPassword = document.getElementById('confirmPassword');
const resetSubmitBtn = document.getElementById('resetSubmitBtn');
const resetCancelBtn = document.getElementById('resetCancelBtn');
const resetMsg = document.getElementById('resetMsg');
const resetError = document.getElementById('resetError');

let currentUser = null;
let currentDesigner = null;

/* ===== helpers ===== */
function showError(el, txt){ el.textContent = txt || ''; }
function setAuthBusy(on, text){
  authMsg.textContent = on ? (text || '处理中...') : '';
}
function setProfileBusy(on, text){
  profileMsg.textContent = on ? (text || '处理中...') : '';
}
function isValidEmail(e){ return /\S+@\S+\.\S+/.test(String(e||'').trim()); }

/* ===== auth handlers ===== */
btnSignIn.addEventListener('click', async () => {
  showError(authError, '');
  const email = (emailEl.value||'').trim();
  const password = (passwordEl.value||'').trim();
  if(!email || !password) return showError(authError, '请填写邮箱和密码');
  try {
    setAuthBusy(true, '登录中...');
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    setAuthBusy(false);
    if(error) return showError(authError, '登录失败: ' + (error.message || JSON.stringify(error)));
    currentUser = data?.user || null;
    if(!currentUser) {
      const { data: s } = await supabase.auth.getSession();
      currentUser = s?.session?.user || null;
    }
    if(currentUser) await afterLogin();
  } catch(e){
    setAuthBusy(false);
    showError(authError, e.message || e);
  }
});

/* 注册（发送验证邮件） */
btnRegister.addEventListener('click', async () => {
  showError(authError, '');
  const email = (emailEl.value||'').trim();
  const password = (passwordEl.value||'').trim();
  if(!email || !password) return showError(authError, '请填写邮箱和密码用于注册');
  try {
    setAuthBusy(true, '注册中（将发送验证邮件）...');
    const redirectTo = window.location.origin + window.location.pathname;
    const { data, error } = await supabase.auth.signUp({ email, password }, { redirectTo });
    setAuthBusy(false);
    if(error) return showError(authError, '注册失败: ' + (error.message || JSON.stringify(error)));
    authMsg.textContent = '注册成功，已发送验证邮件，请完成邮箱验证后再登录。';
  } catch(e){
    setAuthBusy(false);
    showError(authError, e.message || e);
  }
});

/* 打开忘记密码弹框 */
btnForgotPassword.addEventListener('click', () => {
  forgotEmail.value = emailEl.value || '';
  forgotMsg.textContent = '';
  forgotError.textContent = '';
  forgotModal.style.display = 'block';
});

/* 取消忘记密码弹框 */
forgotCancelBtn.addEventListener('click', () => { forgotModal.style.display = 'none'; });

/* 发送忘记密码邮件 */
forgotSendBtn.addEventListener('click', async () => {
  forgotError.textContent = '';
  forgotMsg.textContent = '';
  const em = (forgotEmail.value||'').trim();
  if(!isValidEmail(em)) return showError(forgotError, '请填写有效邮箱');
  try {
    forgotMsg.textContent = '正在发送重置邮件...';
    const redirectTo = window.location.origin + window.location.pathname; // 点击邮件回到本页
    const { data, error } = await supabase.auth.resetPasswordForEmail(em, { redirectTo });
    forgotMsg.textContent = '';
    if(error) {
      // 注意：出于隐私/安全考虑，Supabase 可能不会在客户端泄露邮箱存在与否的细节
      return showError(forgotError, '发送失败: ' + (error.message || JSON.stringify(error)));
    }
    forgotMsg.textContent = '已发送重置邮件（若该邮箱存在，请查收）。';
  } catch(e){
    showError(forgotError, e.message || e);
  }
});

/* 注销 */
btnSignOut.addEventListener('click', async () => {
  await supabase.auth.signOut();
  currentUser = null;
  currentDesigner = null;
  authCard.style.display = '';
  profileCard.style.display = 'none';
  rightTopArea.textContent = '未登录';
  btnSignOut.style.display = 'none';
  btnSignIn.style.display = '';
  btnRegister.style.display = '';
  passwordEl.value = '';
  showError(profileError, '');
  profileMsg.textContent = '';
});

/* after login: fetch designers via Edge Function.
   If a designers record exists -> redirect to index.html (首页)
   If not -> show profileCard for filling in data.
*/
async function afterLogin(){
  const { data } = await supabase.auth.getSession();
  currentUser = data?.session?.user || currentUser;
  if(!currentUser) {
    const { data: u2 } = await supabase.auth.getUser();
    currentUser = u2?.user || null;
  }
  if(!currentUser) { showError(authError, '无法获取登录用户'); return; }

  rightTopArea.textContent = `已登录： ${currentUser.email || currentUser.id}`;
  authCard.style.display = 'none';
  btnSignOut.style.display = '';

  try {
    const token = (await supabase.auth.getSession()).data?.session?.access_token;
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/designers`, {
      headers: { Authorization: token ? 'Bearer ' + token : '' }
    });
    const j = await resp.json().catch(()=>({}));
    if(resp.ok && (j.designer || (Array.isArray(j.designers) && j.designers.length > 0))) {
      // 有设计师记录 -> 直接去首页
      window.location.href = 'index.html';
      return;
    } else {
      // 没有 -> 显示并填写资料
      currentDesigner = null;
      fillProfileForm(null);
      profileMsg.textContent = '尚未填写设计师资料，请填写并保存（用户名为必填）。';
      profileCard.style.display = '';
      return;
    }
  } catch(e){
    // 网络/权限问题仍允许用户填写资料
    profileError.textContent = '读取设计师资料失败: ' + (e.message || e);
    currentDesigner = null;
    fillProfileForm(null);
    profileCard.style.display = '';
  }
}

/* fill profile form */
function fillProfileForm(d){
  if(!d){
    d_username.value = '';
    d_studio.value = '';
    d_website.value = '';
    avatarPreview.src = '';
    brandPreview.src = '';
    d_avatar_file.value = '';
    d_brandlogo_file.value = '';
    return;
  }
  d_username.value = d.username || '';
  d_studio.value = d.studio_name || '';
  d_website.value = d.website || '';
  d_avatar_file.value = '';
  d_brandlogo_file.value = '';
  if(d.avatar_url) avatarPreview.src = d.avatar_url.startsWith('http') ? d.avatar_url : previewUrlFromPath(d.avatar_url);
  else avatarPreview.src = '';
  if(d.brand_logo_url) brandPreview.src = d.brand_logo_url.startsWith('http') ? d.brand_logo_url : previewUrlFromPath(d.brand_logo_url);
  else brandPreview.src = '';
}

/* preview images */
d_avatar_file.addEventListener('change', () => {
  const f = d_avatar_file.files[0];
  avatarPreview.src = f ? URL.createObjectURL(f) : (currentDesigner?.avatar_url ? previewUrlFromPath(currentDesigner.avatar_url) : '');
});
d_brandlogo_file.addEventListener('change', () => {
  const f = d_brandlogo_file.files[0];
  brandPreview.src = f ? URL.createObjectURL(f) : (currentDesigner?.brand_logo_url ? previewUrlFromPath(currentDesigner.brand_logo_url) : '');
});

/* save profile */
btnSaveProfile.addEventListener('click', async () => {
  showError(profileError, '');
  profileMsg.textContent = '';
  const username = (d_username.value||'').trim();
  if(!username) return showError(profileError, '用户名为必填项');

  try {
    setProfileBusy(true, '正在保存资料并上传图片（如有）...');
    const token = (await supabase.auth.getSession()).data?.session?.access_token;

    const payload = {
      username,
      avatar_url: null,
      studio_name: (d_studio.value||'').trim() || null,
      brand_logo_url: null,
      website: (d_website.value||'').trim() || null
    };

    // upload avatar/logo via your upload-via-server function
    if(d_avatar_file.files && d_avatar_file.files[0]) {
      const f = d_avatar_file.files[0];
      const path = await uploadFileToServer(f, 'avatars');
      payload.avatar_url = typeof path === 'string' ? path : String(path);
    } else if(currentDesigner?.avatar_url) {
      payload.avatar_url = currentDesigner.avatar_url;
    }
    if(d_brandlogo_file.files && d_brandlogo_file.files[0]) {
      const f = d_brandlogo_file.files[0];
      const path = await uploadFileToServer(f, 'brand_logos');
      payload.brand_logo_url = typeof path === 'string' ? path : String(path);
    } else if(currentDesigner?.brand_logo_url) {
      payload.brand_logo_url = currentDesigner.brand_logo_url;
    }

    const method = currentDesigner ? 'PUT' : 'POST';
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/designers`, {
      method,
      headers: {
        'Content-Type': 'application/json',
        Authorization: token ? 'Bearer ' + token : ''
      },
      body: JSON.stringify(payload)
    });
    const j = await resp.json().catch(()=>({}));
    if(!resp.ok){
      const em = j?.error || j?.message || JSON.stringify(j);
      throw new Error('保存失败: ' + em);
    }
    currentDesigner = j.designer || (Array.isArray(j.designers) && j.designers[0]) || currentDesigner || payload;
    profileMsg.textContent = '保存成功，正在跳转到首页...';
    setTimeout(()=> window.location.href = 'index.html', 800);
  } catch(e){
    showError(profileError, e.message || e);
  } finally {
    setProfileBusy(false);
  }
});

/* upload file to Edge Function upload-via-server */
async function uploadFileToServer(file, bucket = null){
  if(!file) return null;
  const MAX = 6 * 1024 * 1024;
  if(file.size > MAX) throw new Error('文件过大（建议 ≤6MB）');
  const token = (await supabase.auth.getSession()).data?.session?.access_token;
  const form = new FormData();
  form.append('file', file, file.name);
  if(bucket) form.append('bucket', bucket);
  const resp = await fetch(`${SUPABASE_URL}/functions/v1/upload-via-server`, {
    method: 'POST',
    headers: token ? { Authorization: 'Bearer ' + token } : {},
    body: form
  });
  const j = await resp.json().catch(()=>({}));
  if(!resp.ok) {
    const msg = j?.error || j?.message || JSON.stringify(j);
    throw new Error('上传失败: ' + msg);
  }
  const path = j.path || j.data?.path || j.url || j.public_url || j;
  return typeof path === 'string' ? path : JSON.stringify(path);
}

/* preview helper */
function previewUrlFromPath(p){
  if(!p) return '';
  if(typeof p !== 'string') return '';
  if(p.startsWith('http://') || p.startsWith('https://')) return p;
  const cleaned = p.replace(/^\/+/, '');
  return `${SUPABASE_URL}/storage/v1/object/public/${cleaned}`;
}

/* ------------------------
   handle magic-link / reset link in URL
   - when user clicks reset link in email, Supabase will redirect back with access_token & type=recovery
   - we set session, and if type=recovery show resetModal for setting new password
   ------------------------ */
async function parseParamsFromHashOrSearch() {
  const res = {};
  const hashPart = (window.location.hash || '').replace(/^#/, '');
  const searchPart = (window.location.search || '').replace(/^\?/, '');
  const p = new URLSearchParams(hashPart || searchPart);
  for (const [k, v] of p.entries()) res[k] = v;
  return res;
}
async function tryHandleAuthFromUrl() {
  try {
    const params = await parseParamsFromHashOrSearch();
    const isRecovery = params.type === 'recovery' || params['type'] === 'recovery';
    if (params.access_token) {
      const access_token = params.access_token;
      const refresh_token = params.refresh_token || null;
      try {
        const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) console.warn('[Auth] setSession error', error);
      } catch (e) { console.warn(e); }
      // show reset modal if recovery flow
      if (isRecovery) {
        // give time to set session
        setTimeout(()=> {
          resetError.textContent = '';
          resetMsg.textContent = '';
          newPassword.value = '';
          confirmPassword.value = '';
          resetModal.style.display = 'block';
        }, 300);
      } else {
        // normal magic link sign-in: continue to app logic
        // delay to let auth state subscription handle it
        setTimeout(()=> afterLogin(), 300);
      }
      // clean up url to remove tokens
      const cleanUrl = window.location.origin + window.location.pathname + window.location.search;
      window.history.replaceState({}, document.title, cleanUrl);
    }
    if (params.error) {
      const desc = params.error_description ? decodeURIComponent(params.error_description) : params.error;
      authMsg.textContent = '验证链接返回：' + desc;
      const cleanUrl = window.location.origin + window.location.pathname + window.location.search;
      window.history.replaceState({}, document.title, cleanUrl);
    }
  } catch(e){ console.warn('tryHandleAuthFromUrl exception', e); }
}

/* reset modal handlers */
resetCancelBtn.addEventListener('click', () => {
  resetModal.style.display = 'none';
  // optionally sign out to clear session
  supabase.auth.signOut();
});

resetSubmitBtn.addEventListener('click', async () => {
  resetError.textContent = '';
  resetMsg.textContent = '';
  const p1 = (newPassword.value||'').trim();
  const p2 = (confirmPassword.value||'').trim();
  if(!p1 || p1.length < 8) return showError(resetError, '请填写至少 8 位新密码');
  if(p1 !== p2) return showError(resetError, '两次密码不一致');
  try {
    resetMsg.textContent = '正在设置新密码...';
    // updateUser requires an authenticated session (we set session earlier from URL)
    const { data, error } = await supabase.auth.updateUser({ password: p1 });
    if(error) {
      resetMsg.textContent = '';
      return showError(resetError, '设置失败: ' + (error.message || JSON.stringify(error)));
    }
    resetMsg.textContent = '密码已重设成功，请使用新密码重新登录。';
    // sign out after short delay, return to login UI
    setTimeout(async () => {
      await supabase.auth.signOut();
      resetModal.style.display = 'none';
      authCard.style.display = '';
      profileCard.style.display = 'none';
      rightTopArea.textContent = '未登录';
      btnSignOut.style.display = 'none';
      authMsg.textContent = '密码已重设，请使用新密码登录。';
    }, 1200);
  } catch(e){
    resetMsg.textContent = '';
    showError(resetError, e.message || e);
  }
});

/* startup */
(async function init(){
  await tryHandleAuthFromUrl();
  // subscribe auth state changes
  supabase.auth.onAuthStateChange((event, session) => {
    if(session?.access_token) {
      // signed in -> afterLogin will check designers & decide redirect or show profile form
      afterLogin();
    } else {
      // signed out -> default login UI
      currentUser = null;
      currentDesigner = null;
      authCard.style.display = '';
      profileCard.style.display = 'none';
      rightTopArea.textContent = '未登录';
      btnSignOut.style.display = 'none';
      btnSignIn.style.display = '';
      btnRegister.style.display = '';
    }
  });

  // check existing session
  const { data } = await supabase.auth.getSession();
  if(data?.session?.user) {
    currentUser = data.session.user;
    await afterLogin();
  } else {
    authCard.style.display = '';
    profileCard.style.display = 'none';
    btnSignOut.style.display = 'none';
    rightTopArea.textContent = '未登录';
  }
})();
</script>
</body>
</html>
