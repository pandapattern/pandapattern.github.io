<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>我的纸样 — 设计师站</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --accent:#0f766e; --muted:#6b7280; --card:#fff; --radius:12px; --shadow:0 6px 18px rgba(15,23,42,0.06); }
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto; background:#f3f6fb; margin:0; color:#0b1220; }
    .wrap{ max-width:1100px; margin:28px auto; padding:18px; }
    .top{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
    .card{ background:var(--card); padding:14px; border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid rgba(2,6,23,0.04); }
    h1{ margin:0; font-size:18px; }
    .row{ display:flex; gap:8px; align-items:center; }
    button{ background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(15,118,110,0.12); }
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th,td{ text-align:left; padding:8px 6px; border-bottom:1px solid #f0f2f4; }
    .muted{ color:var(--muted); font-size:13px; }
    a.link{ color:var(--accent); text-decoration:none; font-weight:600; margin-left:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>我的纸样（设计师）</h1>
        <div class="muted" id="userInfo">加载中...</div>
      </div>
      <div class="row">
        <button id="btnNew">新建纸样</button>
        <button id="btnRefresh" class="ghost">刷新</button>
        <button id="btnSignOut" class="ghost">登出</button>
      </div>
    </div>

    <div id="listCard" class="card">
      <div class="muted">你的纸样会显示在此。点击“新建”或“编辑”进入编辑页面。</div>
      <table id="patternsTable">
        <thead><tr><th style="width:28px">#</th><th>标题</th><th style="width:160px">操作</th></tr></thead>
        <tbody id="patternsTbody"></tbody>
      </table>
    </div>

    <div id="log" style="margin-top:12px;" class="muted small"></div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://fdxvtmgmmrpdkwhrbsfl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkeHZ0bWdtbXJwZGt3aHJic2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzY0NTUsImV4cCI6MjA3NDkxMjQ1NX0.iU-T3S8OzgGSXtbIf6D7WsMAaIXKNqZE8ooScS4udEk";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const userInfo = document.getElementById('userInfo');
const btnSignOut = document.getElementById('btnSignOut');
const btnNew = document.getElementById('btnNew');
const btnRefresh = document.getElementById('btnRefresh');
const patternsTbody = document.getElementById('patternsTbody');
const logEl = document.getElementById('log');

function log(msg){ logEl.textContent = new Date().toLocaleTimeString() + " " + msg + "\n" + logEl.textContent; }

async function requireLogin(){
  const { data } = await supabase.auth.getSession();
  const user = data?.session?.user;
  if(!user){
    // redirect to login
    window.location.href = 'login.html';
    throw new Error('not logged in');
  }
  return user;
}

async function loadPatterns(){
  try {
    const user = await requireLogin();
    // show email + "编辑信息" 链接
    const emailOrId = user.email || user.id;
    userInfo.innerHTML = `${emailOrId} <a class="link" href="login.html?edit=1">编辑信息</a>`;
    log('加载纸样...');
    const { data, error } = await supabase
      .from('patterns')
      .select('id,title,created_at,original_pdf_name,visibility,status')
      .eq('designer_id', user.id)
      .order('created_at', { ascending:false })
      .limit(500);
    if(error) { patternsTbody.innerHTML = `<tr><td colspan="3">加载失败: ${error.message}</td></tr>`; log('err '+error.message); return; }
    renderList(data || []);
  } catch(e){
    console.error(e);
  }
}

function renderList(arr){
  patternsTbody.innerHTML = '';
  if(!arr || arr.length === 0) {
    patternsTbody.innerHTML = '<tr><td colspan="3" class="muted">尚无记录</td></tr>';
    return;
  }
  arr.forEach((p, idx) => {
    const tr = document.createElement('tr');
    const titleEsc = (p.title||'').replace(/</g,'&lt;');
    tr.innerHTML = `<td>${idx+1}</td>
      <td><div style="max-width:520px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${titleEsc}</div></td>
      <td style="text-align:right">
        <button data-id="${p.id}" class="btn-edit">编辑</button>
        <button data-id="${p.id}" class="btn-download">下载</button>
      </td>`;
    tr.querySelector('.btn-edit').addEventListener('click', () => {
      // go to designer.html for edit
      window.location.href = `designer.html?id=${p.id}`;
    });
    tr.querySelector('.btn-download').addEventListener('click', async () => {
      try {
        const token = (await supabase.auth.getSession()).data?.session?.access_token;
        const resp = await fetch(`${SUPABASE_URL}/functions/v1/get-signed-pdf`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify({ patternId: p.id, expires_sec: 300 })
        });
        const j = await resp.json();
        if(!resp.ok) { alert('获取签名失败: '+(j?.error||JSON.stringify(j))); return; }
        const su = j.signedUrl || j.signed_url || j.downloadUrl;
        if(!su) { alert('后端未返回 signed url'); return; }
        window.open(su, '_blank');
      } catch(e){
        alert('签名获取异常: ' + e.message);
      }
    });
    patternsTbody.appendChild(tr);
  });
}

btnNew.addEventListener('click', () => {
  window.location.href = 'designer.html';
});

btnRefresh.addEventListener('click', loadPatterns);

btnSignOut.addEventListener('click', async () => {
  await supabase.auth.signOut();
  window.location.href = 'login.html';
});

/* initial */
(async function(){
  try {
    await requireLogin();
    await loadPatterns();
  } catch(e){
    // redirected
  }
})();
</script>
</body>
</html>
