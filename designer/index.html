---
layout: designer
title: 设计师面板
permalink: /designer/      
---
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>设计师面板 — 上传纸样 & 教程 管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0f766e;
      --accent-2:#0ea5a3;
      --danger:#ef4444;
      --radius:12px;
      --shadow: 0 6px 18px rgba(15,23,42,0.06);
      --glass: rgba(255,255,255,0.6);
    }
    html,body{height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#f3f6fb, #eef2f6); color:#0b1220;}
    .container{max-width:1100px; margin:28px auto; padding:20px;}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px;}
    h1{font-size:20px; margin:0; font-weight:600;}
    .subtitle{color:var(--muted); font-size:13px;}
    .grid{display:grid; grid-template-columns: 1fr 380px; gap:18px;}
    @media (max-width:980px){ .grid{grid-template-columns: 1fr; } .rightCol{order:2} }

    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; border:1px solid rgba(15,23,42,0.04);}
    label{display:block; font-weight:600; margin-top:12px; font-size:13px;}
    input[type="text"], input[type="email"], input[type="password"], textarea, select { width:100%; padding:10px; box-sizing:border-box; margin-top:6px; border-radius:8px; border:1px solid #e6e8eb; font-size:14px; background:#fff; }
    textarea{min-height:68px; resize:vertical;}
    .row{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;}
    button{background:var(--accent); color:white; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;}
    button.ghost{background:transparent; color:var(--accent); border:1px solid rgba(15,118,110,0.12);}
    button.warn{background:var(--danger);}
    button:disabled{opacity:0.65; cursor:not-allowed;}
    .muted{color:var(--muted); font-size:13px;}
    .small{font-size:13px; color:#666;}
    pre{background:#0b122033; color:#0b1220; padding:10px; border-radius:8px; overflow:auto; font-size:13px;}
    a.link{color:var(--accent-2); text-decoration:none; font-weight:600;}

    /* status top bar */
    .statusBar { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; background:linear-gradient(90deg, rgba(14,165,233,0.06), rgba(79,70,229,0.02)); border:1px solid rgba(14,165,233,0.08); margin-bottom:12px; }
    .spinner { width:18px; height:18px; border-radius:50%; border:3px solid rgba(0,0,0,0.08); border-top-color:var(--accent); animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* overlay when busy */
    .overlay { position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; z-index:1200; }
    .overlay .pane { background:var(--glass); padding:18px; border-radius:12px; backdrop-filter: blur(6px); box-shadow:0 10px 30px rgba(2,6,23,0.2); border:1px solid rgba(255,255,255,0.6); display:flex; gap:12px; align-items:center;}
    .overlay.hidden{display:none;}

    .progressWrap{margin-top:12px;}
    .progress{height:10px; background:#e6eef0; border-radius:999px; overflow:hidden;}
    .progress > .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transition:width 0.2s ease;}

    /* nicer list */
    .rightCol .card{margin-bottom:12px;}
    .smallNote{font-size:12px;color:var(--muted); margin-top:6px;}

    /* file input nicer */
    .fileRow{display:flex; align-items:center; gap:8px;}
    .fileName{font-size:13px; color:#111; padding:8px 10px; background:#fafafa; border-radius:8px; border:1px dashed #eee; flex:1;}

    /* materials table improvements */
    .materialsWrap { overflow:auto; max-width:100%; }
    table.mat { width:100%; border-collapse:collapse; font-size:13px; }
    table.mat th, table.mat td { padding:8px 6px; border-bottom:1px solid #f0f2f4; text-align:left; vertical-align:middle; }
    table.mat th { font-weight:700; color:var(--muted); font-size:12px; white-space:nowrap; }
    table.mat td input { width:100%; padding:8px; border-radius:8px; border:1px solid #e6e8eb; box-sizing:border-box; }
    .mat-actions { display:flex; gap:8px; }
    .mat-actions button { padding:6px 8px; border-radius:8px; font-size:13px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>设计师面板 — 纸样 & 教程 管理</h1>
        <div class="subtitle">上传原始 PDF → 后端处理 → 下载处理后 PDF</div>
      </div>
      <div id="userArea" class="muted">未登录</div>
    </header>

    <div class="statusBar card" id="statusBar" style="display:none;">
      <div id="statusSpinner" class="spinner" style="display:none;"></div>
      <div id="statusText" class="small muted">空闲</div>
    </div>

    <div class="grid">
      <!-- left: main -->
      <div>
        <div class="card">
          <label>邮箱登录（邮箱 + 密码）</label>
          <div style="display:flex; gap:8px;">
            <input id="emailInput" type="email" placeholder="designer@example.com" />
            <input id="passwordInput" type="password" placeholder="密码" />
            <button id="signInBtn">登录 / 自动注册（若未注册）</button>
            <button id="signOutBtn" class="ghost" style="display:none;">登出</button>
          </div>
          <div class="smallNote">若该邮箱尚未注册，系统会尝试为你创建账号（若需要邮箱确认，会提示）。</div>
        </div>

        <!-- CREATE & UPLOAD FIRST -->
        <div class="card" style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">创建纸样 & 上传 PDF</h3>
          <label>纸样标题</label>
          <input id="titleInput" type="text" placeholder="纸样标题" />

          <label>纸样描述</label>
          <textarea id="descInput" placeholder="简短描述..."></textarea>

          <label>App 下载 / 打开 链接（二维码指向）</label>
          <input id="appUrl" type="text" placeholder="https://example.com/open?pattern=..." />

          <label>PDF 文件（原始）</label>
          <div class="fileRow">
            <input id="pdfFile" type="file" accept="application/pdf" />
            <div id="fileName" class="fileName">未选择文件</div>
          </div>

          <label>Storage bucket (原始存储位置)</label>
          <input id="bucketName" type="text" value="patterns-originals" />

          <div class="row">
            <button id="createAndUploadBtn">创建并上传(并触发处理)</button>
            <button id="justCreateBtn" class="ghost">仅创建 Pattern</button>
          </div>

          <div class="progressWrap" id="uploadProgressWrap" style="display:none;">
            <div class="small">上传进度</div>
            <div class="progress"><div id="uploadBar" class="bar"></div></div>
            <div class="small muted" id="uploadPct">0%</div>
          </div>

          <div id="processedInfo" style="margin-top:12px;"></div>
        </div>

        <!-- MATERIALS AFTER CREATE -->
        <div class="card" style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">材料清单（pattern_materials）</h3>
          <label>Pattern ID</label>
          <input id="patternIdInput" type="text" placeholder="pattern id (创建后自动填充)" />
          <div class="row">
            <button id="loadMaterialsBtn" class="ghost">加载材料</button>
            <button id="addMaterialBtn" class="ghost">+ 新增行</button>
            <button id="saveMaterialsBtn" class="ghost">保存</button>
          </div>
          <div class="materialsWrap" style="margin-top:10px;">
            <table class="mat" id="materialsTable">
              <thead><tr><th style="width:40px">#</th><th>名称</th><th style="width:80px">数量</th><th>备注</th><th style="width:180px">链接</th><th style="width:80px">动作</th></tr></thead>
              <tbody id="materialsTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- TUTORIALS AFTER MATERIALS -->
        <div class="card" style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">教程 / 媒体 (tutorial_media)</h3>
          <label>媒体标题</label>
          <input id="tutorialTitle" type="text" placeholder="教程标题" />
          <label>类型</label>
          <select id="tutorialType">
            <option value="text">text (文本)</option>
            <option value="pdf">pdf (上传)</option>
            <option value="image">image (上传)</option>
            <option value="video">video (上传)</option>
            <option value="external_link">external_link (外部链接)</option>
          </select>
          <label>外链 / 文本 / 文件</label>
          <input id="tutorialLink" type="text" placeholder="外部链接或简短说明" />
          <input id="tutorialFile" type="file" />
          <div class="row">
            <button id="uploadTutorialBtn">上传并保存教程媒体</button>
            <button id="listTutorialsBtn" class="ghost">列出教程</button>
          </div>

          <div id="tutorialsList" style="margin-top:8px;"></div>
        </div>

      </div>

      <!-- right: sidebar -->
      <div class="rightCol">
        <div class="card">
          <h4 style="margin:0 0 6px 0;">日志 / 返回</h4>
          <pre id="log">等待操作...</pre>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="muted small">说明</div>
          <div class="smallNote">上传时会显示实时进度，处理完成后会在本页显示后端返回（以及下载按钮）。</div>
        </div>
      </div>
    </div>
  </div>

  <!-- overlay -->
  <div id="overlay" class="overlay hidden">
    <div class="pane">
      <div class="spinner" style="width:20px;height:20px;border-width:3px;border-top-color:var(--accent)"></div>
      <div id="overlayText" class="small muted">处理中…</div>
    </div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ==== 配置（内嵌） ==== */
const SUPABASE_URL = "https://fdxvtmgmmrpdkwhrbsfl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkeHZ0bWdtbXJwZGt3aHJic2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzY0NTUsImV4cCI6MjA3NDkxMjQ1NX0.iU-T3S8OzgGSXtbIf6D7WsMAaIXKNqZE8ooScS4udEk";

/* ==== DOM shortcuts ==== */
const emailInput = document.getElementById('emailInput');
const passwordInput = document.getElementById('passwordInput');
const signInBtn = document.getElementById('signInBtn');
const signOutBtn = document.getElementById('signOutBtn');
const userArea = document.getElementById('userArea');

const titleInput = document.getElementById('titleInput');
const descInput = document.getElementById('descInput');
const appUrlInput = document.getElementById('appUrl');
const pdfFileInput = document.getElementById('pdfFile');
const fileNameEl = document.getElementById('fileName');
const bucketNameEl = document.getElementById('bucketName');
const createAndUploadBtn = document.getElementById('createAndUploadBtn');
const justCreateBtn = document.getElementById('justCreateBtn');
const uploadProgressWrap = document.getElementById('uploadProgressWrap');
const uploadBar = document.getElementById('uploadBar');
const uploadPct = document.getElementById('uploadPct');
const processedInfo = document.getElementById('processedInfo');

const tutorialTitle = document.getElementById('tutorialTitle');
const tutorialType = document.getElementById('tutorialType');
const tutorialLink = document.getElementById('tutorialLink');
const tutorialFile = document.getElementById('tutorialFile');
const uploadTutorialBtn = document.getElementById('uploadTutorialBtn');
const listTutorialsBtn = document.getElementById('listTutorialsBtn');

const patternIdInput = document.getElementById('patternIdInput');
const addMaterialBtn = document.getElementById('addMaterialBtn');
const saveMaterialsBtn = document.getElementById('saveMaterialsBtn');
const loadMaterialsBtn = document.getElementById('loadMaterialsBtn');
const materialsTbody = document.getElementById('materialsTbody');

const logEl = document.getElementById('log');
const statusBar = document.getElementById('statusBar');
const statusText = document.getElementById('statusText');
const statusSpinner = document.getElementById('statusSpinner');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');

/* utility logger */
function log(...args){
  const s = args.map(x => (typeof x === 'string' ? x : JSON.stringify(x, null, 2))).join(' ');
  logEl.textContent = new Date().toLocaleTimeString() + " " + s + "\n\n" + logEl.textContent;
  console.log(...args);
}

/* ==== Supabase init & auth housekeeping ==== */
let supabase = null;
function initSupabase(){
  if(!supabase){
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    log('[Supabase] client initialized');
  }
  return supabase;
}
async function updateUserInfoPeriodically(){
  initSupabase();
  if(!supabase) return;
  supabase.auth.onAuthStateChange((event, session) => {
    if(session && session.access_token) updateUserInfo(session.user);
    else updateUserInfo(null);
  });
  const { data } = await supabase.auth.getSession();
  if(data?.session?.user) updateUserInfo(data.session.user);
}
function updateUserInfo(user){
  if(!user){
    userArea.textContent = '未登录';
    signOutBtn.style.display = 'none';
    signInBtn.style.display = '';
  } else {
    userArea.textContent = `${user.email || user.id}`;
    signOutBtn.style.display = '';
    signInBtn.style.display = 'none';
  }
}

/* ==== Busy UI helpers ==== */
function setStatus(text, busy=false){
  statusBar.style.display = text ? 'flex' : 'none';
  statusText.textContent = text || '';
  statusSpinner.style.display = busy ? 'inline-block' : 'none';
}
function showOverlay(text){
  overlay.classList.remove('hidden');
  overlayText.textContent = text || '处理中…';
}
function hideOverlay(){
  overlay.classList.add('hidden');
}
function setUploadProgress(pct){
  uploadProgressWrap.style.display = 'block';
  const clamped = Math.max(0, Math.min(100, Math.round(pct)));
  uploadBar.style.width = clamped + '%';
  uploadPct.textContent = clamped + '%';
  setStatus(`上传中 ${clamped}%`, true);
}
function resetUploadProgress(){
  uploadProgressWrap.style.display = 'none';
  uploadBar.style.width = '0%';
  uploadPct.textContent = '0%';
  setStatus('', false);
}
function setBusyUI(on, message){
  const allButtons = document.querySelectorAll('button');
  allButtons.forEach(b => b.disabled = on);
  if(on) { showOverlay(message || '处理中…'); setStatus(message || '处理中…', true); }
  else { hideOverlay(); setStatus('', false); }
}

/* ==== Auth handlers: signIn with auto-signUp fallback ==== */
signInBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const email = (emailInput.value||'').trim();
    const password = (passwordInput.value||'').trim();
    if(!email || !password) return alert('请填写邮箱和密码');
    setBusyUI(true, '登录中...');
    log('[Auth] signIn attempt', email);

    // try sign in
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if(error){
      log('[Auth] signIn failed', error);
      if(error?.status === 400 || (error?.message && error.message.toLowerCase().includes('invalid'))){
        log('[Auth] trying signUp fallback (auto-register)');
        const { data: upData, error: upErr } = await supabase.auth.signUp({ email, password });
        if(upErr){
          log('[Auth] signUp failed', upErr);
          alert('注册失败: ' + (upErr.message || JSON.stringify(upErr)));
          setBusyUI(false);
          return;
        }
        log('[Auth] signUp success', upData);
        const { data: signin2, error: signin2Err } = await supabase.auth.signInWithPassword({ email, password });
        if(signin2Err){
          log('[Auth] signIn after signUp failed', signin2Err);
          alert('注册成功，请检查邮箱并完成确认后再次登录（若启用了邮箱确认）。错误: ' + (signin2Err.message || JSON.stringify(signin2Err)));
          setBusyUI(false);
          return;
        }
        log('[Auth] signIn after signUp success', signin2);
        updateUserInfo(signin2.user);
        setBusyUI(false);
        alert('已自动注册并登录。');
        return;
      } else {
        alert('登录失败: ' + (error.message || JSON.stringify(error)));
        setBusyUI(false);
        return;
      }
    }

    log('[Auth] signIn success', data?.user?.email || data?.user?.id);
    updateUserInfo(data.user);
    setBusyUI(false);
  } catch(e){
    setBusyUI(false);
    log('[Auth] exception', e);
    alert('登录异常: ' + (e.message || JSON.stringify(e)));
  }
});

signOutBtn.addEventListener('click', async () => {
  if(!supabase) initSupabase();
  await supabase.auth.signOut();
  updateUserInfo(null);
});

/* show chosen filename */
pdfFileInput.addEventListener('change', () => {
  const f = pdfFileInput.files[0];
  fileNameEl.textContent = f ? `${f.name} (${Math.round(f.size/1024)} KB)` : '未选择文件';
});

/* ==== API wrappers (create/upload/process/get-signed) ==== */
async function callCreatePattern(title, description, appDownloadUrl){
  initSupabase();
  const { data } = await supabase.auth.getSession();
  const token = data?.session?.access_token;
  const url = `${SUPABASE_URL}/functions/v1/create-pattern`;
  const headers = { 'Content-Type':'application/json' };
  if(token) headers['Authorization'] = 'Bearer ' + token;
  else throw new Error('未登录：需要登录以创建纸样');
  setStatus('创建 pattern...', true);
  const resp = await fetch(url, { method:'POST', headers, body: JSON.stringify({ title, description, appDownloadUrl }) });
  const j = await resp.json().catch(()=>({ status: resp.status, text: 'non-json' }));
  log('[create-pattern] resp', j);
  if(!j.ok) throw new Error('create-pattern failed: ' + JSON.stringify(j));
  setStatus('', false);
  return j.pattern;
}

/* upload via server using XHR so we can show upload progress */
function uploadFileViaServerXHR(patternId, file, bucket=null){
  return new Promise((resolve, reject) => {
    initSupabase();
    const xhr = new XMLHttpRequest();
    const url = `${SUPABASE_URL}/functions/v1/upload-via-server`;
    xhr.open('POST', url, true);

    supabase.auth.getSession().then(({ data }) => {
      const token = data?.session?.access_token;
      if(token) xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);

      const form = new FormData();
      form.append('file', file, file.name || `upload_${Date.now()}`);
      if(patternId) form.append('patternId', patternId);
      if(bucket) form.append('bucket', bucket);

      xhr.upload.onprogress = function(e){
        if(e.lengthComputable){
          const pct = (e.loaded / e.total) * 100;
          setUploadProgress(pct);
        }
      };
      xhr.onload = function(){
        resetUploadProgress();
        if(xhr.status >=200 && xhr.status <300){
          try{
            const j = JSON.parse(xhr.responseText || '{}');
            log('[upload-via-server] success', j);
            if(!j.ok) { reject(new Error('upload-via-server error: ' + JSON.stringify(j))); return; }
            resolve(j.path || j.data?.path || j);
          } catch(e){
            reject(new Error('upload-via-server parse error: ' + e.message));
          }
        } else {
          reject(new Error('upload-via-server HTTP ' + xhr.status + ': ' + xhr.responseText));
        }
      };
      xhr.onerror = function(){
        resetUploadProgress();
        reject(new Error('upload-via-server network error'));
      };
      xhr.send(form);
    }).catch(err=>{
      reject(new Error('auth session missing'));
    });
  });
}

async function callProcessPatternPdfWithPath(patternId, originalPath, appDownloadUrl){
  initSupabase();
  const { data } = await supabase.auth.getSession();
  const token = data?.session?.access_token;
  if(!token) throw new Error('未登录或 token 为空');
  const url = `${SUPABASE_URL}/functions/v1/process-pattern-pdf`;
  const headers = { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token };
  const body = { patternId, originalFilePath: originalPath, appDownloadUrl };
  setStatus('请求后端处理 PDF...', true);
  const resp = await fetch(url, { method:'POST', headers, body: JSON.stringify(body) });
  const j = await resp.json().catch(()=>({ status: resp.status, text: 'non-json' }));
  log('[process-pattern-pdf] resp', j);
  setStatus('', false);
  return j;
}

async function getSignedPdfForPattern(patternId, expiresSec = 300){
  initSupabase();
  const { data } = await supabase.auth.getSession();
  const token = data?.session?.access_token;
  if(!token) { alert('请先登录'); return; }
  const url = `${SUPABASE_URL}/functions/v1/get-signed-pdf`;
  const headers = { 'Content-Type':'application/json', 'Authorization':'Bearer ' + token };
  const body = { patternId, expires_sec: expiresSec };
  setStatus('获取签名下载链接...', true);
  const resp = await fetch(url, { method:'POST', headers, body: JSON.stringify(body) });
  const j = await resp.json().catch(()=>({ status: resp.status, text: 'non-json' }));
  log('[get-signed-pdf] resp', j);
  setStatus('', false);
  return j;
}

/* ===== UI flows ===== */
createAndUploadBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const file = pdfFileInput.files[0];
    const title = (titleInput.value||'').trim();
    const desc = (descInput.value||'').trim();
    const appDownloadUrl = (appUrlInput.value||'').trim() || undefined;
    const bucket = (bucketNameEl.value||'patterns-originals').trim();
    if(!title) return alert('请填写纸样标题');
    if(!file) return alert('请选择 PDF 文件');

    setBusyUI(true, '创建 paper 并上传中...');
    const pattern = await callCreatePattern(title, desc, appDownloadUrl);
    log('[UI] pattern created', pattern);
    patternIdInput.value = pattern.id;

    setStatus('上传原始 PDF...', true);
    const originalPath = await uploadFileViaServerXHR(pattern.id, file, bucket);
    log('[UI] originalPath', originalPath);

    setStatus('触发后端处理...', true);
    const proc = await callProcessPatternPdfWithPath(pattern.id, originalPath, appDownloadUrl);

    processedInfo.innerHTML = `<div><strong>后端返回：</strong><pre>${JSON.stringify(proc, null, 2)}</pre></div>`;
    const signedUrl = proc?.signedUrl || proc?.signed_url || proc?.signed || proc?.downloadUrl;
    const processedPath = proc?.processedPath || proc?.processed_path || proc?.path || proc?.processed_pdf_path || proc?.processed;
    if(signedUrl){
      processedInfo.innerHTML = `<div>处理完成 — 直接下载： <a class="link" target="_blank" href="${signedUrl}">下载处理后 PDF</a></div>`;
    } else if(processedPath){
      processedInfo.innerHTML = `<div>处理完成 — 存储路径：<code>${processedPath}</code></div>
        <div style="margin-top:8px;"><button id="getSignedForProcessed">获取处理后 PDF 的 Signed URL 并打开</button></div>`;
      document.getElementById('getSignedForProcessed').addEventListener('click', async () => {
        setBusyUI(true, '获取签名链接...');
        const j = await getSignedPdfForPattern(pattern.id, 300);
        setBusyUI(false);
        log('[get-signed-pdf after processedPath] ', j);
        if(!j.ok){ alert('获取签名链接失败: ' + (j.error || JSON.stringify(j))); return; }
        const su = j.signedUrl || j.signed_url || j.signed || j.downloadUrl;
        if(!su){ alert('后端返回但未包含 signedUrl'); return; }
        processedInfo.innerHTML = `<div>Signed URL (expires ${j.expires_sec || 300}s): <a target="_blank" class="link" href="${su}">下载处理后 PDF</a></div>`;
        window.open(su, '_blank');
      });
    } else {
      log('[UI] process response no recognized link');
    }

    processedInfo.scrollIntoView({ behavior: 'smooth' });
    setBusyUI(false);
  } catch (e) {
    setBusyUI(false);
    resetUploadProgress();
    log('[UI] create+upload error', e);
    alert('错误: ' + (e.message || JSON.stringify(e)));
  }
});

/* just create */
justCreateBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const title = (titleInput.value||'').trim();
    const desc = (descInput.value||'').trim();
    const appDownloadUrl = (appUrlInput.value||'').trim() || undefined;
    if(!title) return alert('请填写纸样标题');
    setBusyUI(true, '创建 pattern...');
    const p = await callCreatePattern(title, desc, appDownloadUrl);
    patternIdInput.value = p.id;
    setBusyUI(false);
    alert('已创建 pattern: ' + p.id);
  } catch(e) {
    setBusyUI(false);
    log('create error', e);
    alert('创建失败: ' + (e.message || JSON.stringify(e)));
  }
});

/* tutorial upload */
uploadTutorialBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const pid = (patternIdInput.value||'').trim();
    if(!pid) return alert('请填写 patternId');
    const type = tutorialType.value;
    const title = (tutorialTitle.value||'').trim();
    let body = (tutorialLink.value||'').trim();
    let media_path = null;

    setBusyUI(true, '上传教程媒体...');
    if(type === 'external_link'){
      if(!body) { setBusyUI(false); return alert('请填写外部链接'); }
      media_path = body;
    } else if(type === 'text'){
      if(!body) { setBusyUI(false); return alert('请填写文本内容'); }
    } else {
      const f = tutorialFile.files[0];
      if(!f) { setBusyUI(false); return alert('请选择文件上传'); }
      const path = await uploadFileViaServerXHR(pid, f, 'patterns-assets');
      media_path = path;
    }

    const seq = 0;
    const row = { pattern_id: pid, seq, media_type: type, title, body: type==='text'?body:null, media_path: media_path||null };
    log('insert tutorial_media', row);
    const { data, error } = await supabase.from('tutorial_media').insert([row]).select();
    if(error){ setBusyUI(false); log('tutorial insert err', error); alert('插入失败: ' + error.message); return; }
    setBusyUI(false);
    alert('教程媒体保存成功');
  } catch(e){
    setBusyUI(false);
    log('upload tutorial err', e);
    alert('错误: ' + (e.message || JSON.stringify(e)));
  }
});

/* list tutorials */
listTutorialsBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const pid = (patternIdInput.value||'').trim();
    if(!pid) return alert('请填写 patternId');
    setBusyUI(true, '读取教程...');
    const { data, error } = await supabase.from('tutorial_media').select('*').eq('pattern_id', pid).order('seq', { ascending:true });
    setBusyUI(false);
    if(error){ log('list tutorials err', error); alert('错误:' + error.message); return; }
    tutorialsList.innerHTML = '';
    if(!data || data.length === 0) { tutorialsList.innerHTML = '<div class="muted">暂无教程</div>'; return; }
    const wrap = document.createElement('div');
    data.forEach(d => {
      const el = document.createElement('div');
      el.innerHTML = `<strong>[${d.media_type}] ${d.title || ''}</strong>
        <div>${d.body ? d.body : ''}</div>
        <div>${d.media_path ? '<a target="_blank" class="link" href="' + (SUPABASE_URL.replace('/.co','') + '/storage/v1/object/public/' + d.media_path) + '">打开媒体 (Storage)</a>' : ''}</div><hr/>`;
      wrap.appendChild(el);
    });
    tutorialsList.appendChild(wrap);
  } catch(e){ setBusyUI(false); log('list tutorials err', e); alert('错误:' + e.message); }
});

/* ===== Materials UI improvements ===== */
let matIdCounter = 0;
function addMaterialRow(data = {}) {
  const id = `m${matIdCounter++}`;
  const tr = document.createElement('tr');
  tr.dataset.matId = id;
  tr.innerHTML = `
    <td>${materialsTbody.children.length + 1}</td>
    <td><input data-key="name" placeholder="名称" value="${(data.name||'').replace(/"/g,'&quot;')}" /></td>
    <td><input data-key="qty" placeholder="数量" value="${(data.qty||'')}" /></td>
    <td><input data-key="note" placeholder="备注" value="${(data.note||'').replace(/"/g,'&quot;')}" /></td>
    <td><input data-key="link" placeholder="链接 (可选)" value="${(data.link||'').replace(/"/g,'&quot;')}" /></td>
    <td class="mat-actions"><button class="ghost del">删除</button></td>
  `;
  materialsTbody.appendChild(tr);
  tr.querySelector('button.del').addEventListener('click', () => { tr.remove(); refreshMaterialIndexes(); });
}
function refreshMaterialIndexes(){
  Array.from(materialsTbody.children).forEach((tr, idx) => { tr.children[0].textContent = (idx+1).toString(); });
}
addMaterialBtn.addEventListener('click', () => addMaterialRow());

loadMaterialsBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const pid = (patternIdInput.value||'').trim();
    if(!pid) return alert('请填写 patternId');
    setBusyUI(true, '加载材料...');
    const { data, error } = await supabase.from('pattern_materials').select('*').eq('pattern_id', pid).order('seq', { ascending:true });
    setBusyUI(false);
    if(error){ log('load materials err', error); alert('加载失败:' + error.message); return; }
    materialsTbody.innerHTML = '';
    if(!data || data.length === 0) { addMaterialRow(); return; }
    data.forEach(d => addMaterialRow(d));
  } catch(e){ setBusyUI(false); log('load materials err', e); alert('错误:' + e.message); }
});

saveMaterialsBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const pid = (patternIdInput.value||'').trim();
    if(!pid) return alert('请填写 patternId');
    const rows = [];
    Array.from(materialsTbody.children).forEach((tr, idx) => {
      const name = tr.querySelector('input[data-key="name"]').value.trim();
      const qty = tr.querySelector('input[data-key="qty"]').value.trim();
      const note = tr.querySelector('input[data-key="note"]').value.trim();
      const link = tr.querySelector('input[data-key="link"]').value.trim();
      if(!name) return;
      rows.push({ pattern_id: pid, seq: idx, name, qty, note, link });
    });
    if(rows.length === 0) return alert('没有可保存的材料行');
    setBusyUI(true, '保存材料...');
    const { data, error } = await supabase.from('pattern_materials').insert(rows).select();
    setBusyUI(false);
    if(error){ log('insert materials err', error); alert('插入失败:' + error.message); return; }
    alert('材料保存成功: ' + data.length + ' 行');
  } catch(e){ setBusyUI(false); log('save materials err', e); alert('错误: ' + e.message); }
});

/* initial housekeeping */
await updateUserInfoPeriodically();
setStatus('', false);

/* ensure at least one material row initially */
if(materialsTbody.children.length === 0) addMaterialRow();
</script>
</body>
</html>
