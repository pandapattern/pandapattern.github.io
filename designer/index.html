<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>设计师面板 — 上传纸样 & 教程 管理</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --accent:#0f766e; --accent-2:#0ea5a3;
      --danger:#ef4444; --radius:12px; --shadow: 0 6px 18px rgba(15,23,42,0.06);
      --glass: rgba(255,255,255,0.6);
    }
    html,body{height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(180deg,#f3f6fb, #eef2f6); color:#0b1220;}
    .container{max-width:1100px; margin:28px auto; padding:20px;}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:18px;}
    h1{font-size:20px; margin:0; font-weight:600;}
    .subtitle{color:var(--muted); font-size:13px;}
    .grid{display:grid; grid-template-columns: 1fr 380px; gap:18px;}
    @media (max-width:980px){ .grid{grid-template-columns: 1fr; } .rightCol{order:2} }

    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; border:1px solid rgba(15,23,42,0.04);}
    label{display:block; font-weight:600; margin-top:12px; font-size:13px;}
    input[type="text"], input[type="email"], input[type="password"], textarea, select { width:100%; padding:10px; box-sizing:border-box; margin-top:6px; border-radius:8px; border:1px solid #e6e8eb; font-size:14px; background:#fff; }
    textarea{min-height:68px; resize:vertical;}
    .row{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;}
    button{background:var(--accent); color:white; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;}
    button.ghost{background:transparent; color:var(--accent); border:1px solid rgba(15,118,110,0.12);}
    button.warn{background:var(--danger);}
    button:disabled{opacity:0.65; cursor:not-allowed;}
    .muted{color:var(--muted); font-size:13px;}
    .small{font-size:13px; color:#666;}
    pre{background:#0b122033; color:#0b1220; padding:10px; border-radius:8px; overflow:auto; font-size:13px;}
    a.link{color:var(--accent-2); text-decoration:none; font-weight:600;}

    /* status top bar */
    .statusBar { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; background:linear-gradient(90deg, rgba(14,165,233,0.06), rgba(79,70,229,0.02)); border:1px solid rgba(14,165,233,0.08); margin-bottom:12px; }
    .spinner { width:18px; height:18px; border-radius:50%; border:3px solid rgba(0,0,0,0.08); border-top-color:var(--accent); animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* overlay when busy */
    .overlay { position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; z-index:1200; }
    .overlay .pane { background:var(--glass); padding:18px; border-radius:12px; backdrop-filter: blur(6px); box-shadow:0 10px 30px rgba(2,6,23,0.2); border:1px solid rgba(255,255,255,0.6); display:flex; gap:12px; align-items:center;}
    .overlay.hidden{display:none;}

    .progressWrap{margin-top:12px;}
    .progress{height:10px; background:#e6eef0; border-radius:999px; overflow:hidden;}
    .progress > .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); transition:width 0.2s ease;}

    /* nicer list */
    .rightCol .card{margin-bottom:12px;}
    .smallNote{font-size:12px;color:var(--muted); margin-top:6px;}

    /* file input nicer */
    .fileRow{display:flex; align-items:center; gap:8px;}
    .fileName{font-size:13px; color:#111; padding:8px 10px; background:#fafafa; border-radius:8px; border:1px dashed #eee; flex:1; display:flex; justify-content:space-between; align-items:center;}
    .fileSize{font-size:12px; color:var(--muted); margin-left:8px;}

    /* materials table improvements */
    .materialsWrap { overflow:auto; max-width:100%; }
    table.mat { width:100%; border-collapse:collapse; font-size:13px; }
    table.mat th, table.mat td { padding:8px 6px; border-bottom:1px solid #f0f2f4; text-align:left; vertical-align:middle; }
    table.mat th { font-weight:700; color:var(--muted); font-size:12px; white-space:nowrap; }
    table.mat td input { width:100%; padding:8px; border-radius:8px; border:1px solid #e6e8eb; box-sizing:border-box; }
    .mat-actions { display:flex; gap:8px; }
    .mat-actions button { padding:6px 8px; border-radius:8px; font-size:13px; }

    /* pattern list compact */
    .patternsList { max-height:420px; overflow:auto; }
    table.pat { width:100%; border-collapse:collapse; font-size:13px; }
    table.pat th, table.pat td { padding:8px 6px; border-bottom:1px solid #f0f2f4; vertical-align:middle; }
    table.pat th { font-weight:700; color:var(--muted); font-size:12px; }
    .pat-actions { display:flex; gap:6px; align-items:center; }
    .mutedCell { color:var(--muted); font-size:12px; }
    .tinyBtn { padding:6px 8px; font-size:13px; border-radius:8px; }
    .radioRow { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .radioRow label { font-weight:500; font-size:13px; }

    /* auth row: prevent wrap of sign buttons */
    .authRow { display:flex; gap:8px; align-items:center; flex-wrap:nowrap; }
    .authRow input[type="email"], .authRow input[type="password"] { flex:1; min-width:140px; }
    .authRow button { white-space:nowrap; }
    @media (max-width:560px) {
      .authRow { flex-wrap:wrap; } /* extremely narrow screens allow wrap */
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>设计师面板 — 纸样 & 教程 管理</h1>
        <div class="subtitle">上传纸样 PDF → 后端处理 → 下载处理后 PDF</div>
      </div>
      <div id="userArea" class="muted">未登录</div>
    </header>

    <div class="statusBar card" id="statusBar" style="display:none;">
      <div id="statusSpinner" class="spinner" style="display:none;"></div>
      <div id="statusText" class="small muted">空闲</div>
    </div>

    <div class="grid">
      <!-- left: main -->
      <div>
        <!-- AUTH (separate 登录 / 注册) -->
        <div class="card">
          <label>邮箱登录 / 注册</label>
          <div class="authRow">
            <input id="emailInput" type="email" placeholder="designer@example.com" />
            <input id="passwordInput" type="password" placeholder="密码" />
            <button id="signInBtn">登录</button>
            <button id="registerBtn" class="ghost">注册</button>
            <button id="signOutBtn" class="ghost" style="display:none;">登出</button>
          </div>
          <div class="smallNote">注册后会发送验证邮件。</div>
        </div>

        <!-- CREATE & UPLOAD -->
        <div class="card" style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">纸样</h3>
          <label>纸样名称</label>
          <input id="titleInput" type="text" placeholder="纸样名称" />

          <label>纸样描述</label>
          <textarea id="descInput" placeholder="简短描述..."></textarea>

          <label>上传纸样 PDF 文件（不超过 50M）</label>
          <div class="fileRow">
            <input id="pdfFile" type="file" accept="application/pdf" />
            <div id="fileName" class="fileName">未选择文件 <span id="fileSize" class="fileSize"></span></div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button id="createAndUploadBtn">上传纸样</button>
            <button id="savePatternChangesBtn" class="ghost" style="display:none;">保存修改</button>
          </div>

          <div class="progressWrap" id="uploadProgressWrap" style="display:none;">
            <div class="small">上传进度</div>
            <div class="progress"><div id="uploadBar" class="bar"></div></div>
            <div class="small muted" id="uploadPct">0%</div>
          </div>

          <div id="processedInfo" style="margin-top:12px;"></div>
        </div>

        <!-- MATERIALS AFTER CREATE -->
        <div class="card" style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">材料清单</h3>
          <div class="row">
            <button id="addMaterialBtn" class="ghost">+ 新增行</button>
            <button id="saveMaterialsBtn" class="ghost">保存</button>
            <button id="loadMaterialsBtn" class="ghost">从材料库里添加</button>
          </div>
          <div class="materialsWrap" style="margin-top:10px;">
            <table class="mat" id="materialsTable">
              <thead><tr><th style="width:40px">#</th><th>名称</th><th style="width:80px">数量</th><th>备注</th><th style="width:180px">链接</th><th style="width:80px">动作</th></tr></thead>
              <tbody id="materialsTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- TUTORIALS AFTER MATERIALS -->
        <div class="card" style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0;">教程文件</h3>

          <label>教程名称</label>
          <input id="tutorialTitle" type="text" placeholder="教程标题" />

          <label>类型</label>
          <div class="radioRow" id="tutorialTypeRow">
            <label><input type="radio" name="tutType" value="text" checked> 文本</label>
            <label><input type="radio" name="tutType" value="pdf"> PDF（上传，≤50M）</label>
            <label><input type="radio" name="tutType" value="image"> 图片（上传，≤50M）</label>
            <label><input type="radio" name="tutType" value="video"> 视频（上传，≤50M）</label>
            <label><input type="radio" name="tutType" value="external_link"> 外部链接</label>
          </div>

          <label id="tutorialBodyLabel" style="margin-top:10px;">外链 / 文本 / 文件</label>
          <input id="tutorialLink" type="text" placeholder="外部链接或简短说明" style="display:block;" />
          <input id="tutorialFile" type="file" style="display:none;" />

          <div class="row" style="margin-top:10px;">
            <button id="uploadTutorialBtn">上传教程文件</button>
            <button id="listTutorialsBtn" class="ghost">列出教程</button>
          </div>

          <div id="tutorialsList" style="margin-top:8px;"></div>
        </div>
      </div>

      <!-- right: sidebar -->
      <div class="rightCol">
        <!-- COMPACT Patterns list -->
        <div class="card">
          <h4 style="margin:0 0 6px 0;">我的纸样</h4>
          <div class="row" style="margin-top:10px;">
            <button id="refreshPatternsBtn" class="ghost">刷新</button>
            <button id="newPatternFocusBtn" class="ghost">新建</button>
          </div>
          <div class="patternsList" style="margin-top:12px;">
            <table class="pat" id="patternsTable">
              <thead><tr><th style="width:18px">#</th><th>标题</th><th style="width:120px">操作</th></tr></thead>
              <tbody id="patternsTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h4 style="margin:0 0 6px 0;">日志 / 返回</h4>
          <pre id="log">等待操作...</pre>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="muted small">说明</div>
          <div class="smallNote">上传文件限制 50MB，超出将被阻止。编辑时会把选中的纸样信息填到左侧表单，修改后点“保存修改”提交更改。</div>
        </div>
      </div>
    </div>
  </div>

  <!-- overlay -->
  <div id="overlay" class="overlay hidden">
    <div class="pane">
      <div class="spinner" style="width:20px;height:20px;border-width:3px;border-top-color:var(--accent)"></div>
      <div id="overlayText" class="small muted">处理中…</div>
    </div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ==== 配置（内嵌） ==== */
const SUPABASE_URL = "https://fdxvtmgmmrpdkwhrbsfl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkeHZ0bWdtbXJwZGt3aHJic2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzY0NTUsImV4cCI6MjA3NDkxMjQ1NX0.iU-T3S8OzgGSXtbIf6D7WsMAaIXKNqZE8ooScS4udEk";

/* ==== DOM shortcuts ==== */
const emailInput = document.getElementById('emailInput');
const passwordInput = document.getElementById('passwordInput');
const signInBtn = document.getElementById('signInBtn');
const registerBtn = document.getElementById('registerBtn');
const signOutBtn = document.getElementById('signOutBtn');
const userArea = document.getElementById('userArea');

const titleInput = document.getElementById('titleInput');
const descInput = document.getElementById('descInput');
const pdfFileInput = document.getElementById('pdfFile');
const fileNameEl = document.getElementById('fileName');
const fileSizeEl = document.getElementById('fileSize');
const createAndUploadBtn = document.getElementById('createAndUploadBtn');
const savePatternChangesBtn = document.getElementById('savePatternChangesBtn');
const uploadProgressWrap = document.getElementById('uploadProgressWrap');
const uploadBar = document.getElementById('uploadBar');
const uploadPct = document.getElementById('uploadPct');
const processedInfo = document.getElementById('processedInfo');

const tutorialTitle = document.getElementById('tutorialTitle');
const tutorialTypeRow = document.getElementById('tutorialTypeRow');
const tutorialLink = document.getElementById('tutorialLink');
const tutorialFile = document.getElementById('tutorialFile');
const uploadTutorialBtn = document.getElementById('uploadTutorialBtn');
const listTutorialsBtn = document.getElementById('listTutorialsBtn');
const tutorialsList = document.getElementById('tutorialsList');

const addMaterialBtn = document.getElementById('addMaterialBtn');
const saveMaterialsBtn = document.getElementById('saveMaterialsBtn');
const loadMaterialsBtn = document.getElementById('loadMaterialsBtn');
const materialsTbody = document.getElementById('materialsTbody');

const logEl = document.getElementById('log');
const statusBar = document.getElementById('statusBar');
const statusText = document.getElementById('statusText');
const statusSpinner = document.getElementById('statusSpinner');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');

const refreshPatternsBtn = document.getElementById('refreshPatternsBtn');
const patternsTbody = document.getElementById('patternsTbody');
const newPatternFocusBtn = document.getElementById('newPatternFocusBtn');

const MAX_FILE_BYTES = 50 * 1024 * 1024; // 50 MB

let supabase = null;
let currentUser = null;
let editingPatternId = null; // hidden internal id of the pattern being edited

/* utility logger */
function log(...args){
  const s = args.map(x => (typeof x === 'string' ? x : JSON.stringify(x, null, 2))).join(' ');
  logEl.textContent = new Date().toLocaleTimeString() + " " + s + "\n\n" + logEl.textContent;
  console.log(...args);
}

/* ==== Supabase init & auth housekeeping ==== */
function initSupabase(){
  if(!supabase){
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    log('[Supabase] client initialized');
  }
  return supabase;
}
async function updateUserInfoPeriodically(){
  initSupabase();
  if(!supabase) return;
  supabase.auth.onAuthStateChange((event, session) => {
    if(session && session.access_token) updateUserInfo(session.user);
    else updateUserInfo(null);
  });
  const { data } = await supabase.auth.getSession();
  if(data?.session?.user) updateUserInfo(data.session.user);
}
function updateUserInfo(user){
  currentUser = user || null;
  if(!user){
    userArea.textContent = '未登录';
    signOutBtn.style.display = 'none';
    signInBtn.style.display = '';
    registerBtn.style.display = '';
    patternsTbody.innerHTML = '';
    // clear editing state and visible content
    editingPatternId = null;
    titleInput.value = '';
    descInput.value = '';
    materialsTbody.innerHTML = '';
    tutorialsList.innerHTML = '';
    processedInfo.innerHTML = '';
    ensureFiveRows();
  } else {
    userArea.textContent = `${user.email || user.id}`;
    signOutBtn.style.display = '';
    signInBtn.style.display = 'none';
    registerBtn.style.display = 'none';
    // auto load patterns for this user
    loadPatterns();
  }
  // update action buttons based on editingPatternId / login state
  updateActionButtonsState();
}

/* ==== Busy UI helpers ==== */
function setStatus(text, busy=false){
  statusBar.style.display = text ? 'flex' : 'none';
  statusText.textContent = text || '';
  statusSpinner.style.display = busy ? 'inline-block' : 'none';
}
function showOverlay(text){ overlay.classList.remove('hidden'); overlayText.textContent = text || '处理中…'; }
function hideOverlay(){ overlay.classList.add('hidden'); }
function setUploadProgress(pct){
  uploadProgressWrap.style.display = 'block';
  const clamped = Math.max(0, Math.min(100, Math.round(pct)));
  uploadBar.style.width = clamped + '%';
  uploadPct.textContent = clamped + '%';
  setStatus(`上传中 ${clamped}%`, true);
}
function resetUploadProgress(){ uploadProgressWrap.style.display = 'none'; uploadBar.style.width = '0%'; uploadPct.textContent = '0%'; setStatus('', false); }
function setBusyUI(on, message){
  const allButtons = document.querySelectorAll('button');
  allButtons.forEach(b => b.disabled = on);
  if(on) { showOverlay(message || '处理中…'); setStatus(message || '处理中…', true); }
  else { hideOverlay(); setStatus('', false); updateActionButtonsState(); }
}

/* ===== buttons enable/disable based on whether a pattern is selected ===== */
function updateActionButtonsState(){
  // buttons that require an existing/selected pattern (pattern_id)
  const requirePatternButtons = [ saveMaterialsBtn, loadMaterialsBtn, uploadTutorialBtn, listTutorialsBtn, savePatternChangesBtn ];
  const isEnabled = !!editingPatternId && !!currentUser;
  requirePatternButtons.forEach(b => {
    if(!b) return;
    b.disabled = !isEnabled;
    b.title = isEnabled ? '' : '请先创建或选择一个纸样';
  });
  // allow adding rows even without saved pattern (draft)
  if(addMaterialBtn) {
    addMaterialBtn.disabled = false;
    addMaterialBtn.title = '';
  }
}

/* ==== AUTH: 登录 与 注册（分开） ==== */
signInBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const email = (emailInput.value||'').trim();
    const password = (passwordInput.value||'').trim();
    if(!email || !password) return alert('请填写邮箱和密码');
    setBusyUI(true, '登录中...');
    log('[Auth] signIn attempt', email);
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    setBusyUI(false);
    if(error){ log('[Auth] signIn failed', error); alert('登录失败: ' + (error.message || JSON.stringify(error))); return; }
    log('[Auth] signIn success', data?.user?.email || data?.user?.id);
    updateUserInfo(data.user);
  } catch(e){
    setBusyUI(false);
    log('[Auth] exception', e);
    alert('登录异常: ' + (e.message || JSON.stringify(e)));
  }
});

/* Improved signUp:
   - 使用 redirectTo：使得确认邮件返回到当前页面
   - 更友好的错误处理（已注册等）
*/
registerBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const email = (emailInput.value||'').trim();
    const password = (passwordInput.value||'').trim();
    if(!email || !password) return alert('请填写邮箱和密码用于注册');

    const redirectTo = window.location.origin + window.location.pathname; // 回到当前页面
    setBusyUI(true, '注册中（将发送验证邮件）...');
    log('[Auth] signUp attempt', email);

    const { data, error } = await supabase.auth.signUp(
      { email, password },
      { redirectTo }
    );
    setBusyUI(false);

    if (error) {
      log('[Auth] signUp failed', error);
      const msg = (error.message || '').toLowerCase();
      // 常见已注册提示判断（不同项目/版本返回的 message 会不同）
      if (msg.includes('already') || msg.includes('exist') || msg.includes('registered') || error.status === 400 || error.status === 409) {
        return alert('该邮箱已被注册。请直接使用“登录”进行登录，或使用忘记密码流程重置密码。');
      }
      return alert('注册失败: ' + (error.message || JSON.stringify(error)));
    }

    alert('注册成功，验证邮件已发送。请打开你的邮箱并点击验证链接。验证完成后请返回此页面并使用「登录」按钮登录（如果验证链接包含 token，本页面会尝试自动登录）。');
    log('[Auth] signUp result', data);
  } catch(e){
    setBusyUI(false);
    log('[Auth] signUp exception', e);
    alert('注册异常: ' + (e.message || JSON.stringify(e)));
  }
});

signOutBtn.addEventListener('click', async () => {
  if(!supabase) initSupabase();
  await supabase.auth.signOut();
  editingPatternId = null;
  updateUserInfo(null);
  updateActionButtonsState();
});

/* show chosen filename + size and enforce 50MB limit for main PDF */
pdfFileInput.addEventListener('change', () => {
  const f = pdfFileInput.files[0];
  if(!f) {
    fileNameEl.innerHTML = '未选择文件 <span id="fileSize" class="fileSize"></span>';
    fileSizeEl.textContent = '';
    return;
  }
  if(f.size > MAX_FILE_BYTES) {
    alert('文件过大（>50MB），请选择更小的 PDF');
    pdfFileInput.value = '';
    fileNameEl.innerHTML = '未选择文件 <span id="fileSize" class="fileSize"></span>';
    return;
  }
  const sizeKB = Math.round(f.size / 1024);
  fileNameEl.innerHTML = `<span style="flex:1">${f.name}</span><span class="fileSize">${sizeKB} KB</span>`;
});

/* ==== API wrappers (simplified) ==== */
async function callCreatePattern(title, description){
  initSupabase();
  const { data } = await supabase.auth.getSession();
  const token = data?.session?.access_token;
  const url = `${SUPABASE_URL}/functions/v1/create-pattern`;
  const headers = { 'Content-Type':'application/json' };
  if(token) headers['Authorization'] = 'Bearer ' + token;
  else throw new Error('未登录：需要登录以创建纸样');
  setStatus('创建 pattern...', true);
  const resp = await fetch(url, { method:'POST', headers, body: JSON.stringify({ title, description }) });
  const j = await resp.json().catch(()=>({ status: resp.status, text: 'non-json' }));
  log('[create-pattern] resp', j);
  if(!j.ok) throw new Error('create-pattern failed: ' + JSON.stringify(j));
  setStatus('', false);
  return j.pattern;
}

/* upload via server using XHR (show progress) */
function uploadFileViaServerXHR(patternId, file, bucket=null){
  return new Promise((resolve, reject) => {
    initSupabase();
    const xhr = new XMLHttpRequest();
    const url = `${SUPABASE_URL}/functions/v1/upload-via-server`;
    xhr.open('POST', url, true);

    supabase.auth.getSession().then(({ data }) => {
      const token = data?.session?.access_token;
      if(token) xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);

      const form = new FormData();
      form.append('file', file, file.name || `upload_${Date.now()}`);
      if(patternId) form.append('patternId', patternId);
      if(bucket) form.append('bucket', bucket);

      xhr.upload.onprogress = function(e){
        if(e.lengthComputable){
          const pct = (e.loaded / e.total) * 100;
          setUploadProgress(pct);
        }
      };
      xhr.onload = function(){
        resetUploadProgress();
        if(xhr.status >=200 && xhr.status <300){
          try{
            const j = JSON.parse(xhr.responseText || '{}');
            log('[upload-via-server] success', j);
            if(!j.ok) { reject(new Error('upload-via-server error: ' + JSON.stringify(j))); return; }
            resolve(j.path || j.data?.path || j);
          } catch(e){
            reject(new Error('upload-via-server parse error: ' + e.message));
          }
        } else {
          reject(new Error('upload-via-server HTTP ' + xhr.status + ': ' + xhr.responseText));
        }
      };
      xhr.onerror = function(){
        resetUploadProgress();
        reject(new Error('upload-via-server network error'));
      };
      xhr.send(form);
    }).catch(err=>{
      reject(new Error('auth session missing'));
    });
  });
}

/* process-pattern-pdf call */
async function callProcessPatternPdfWithPath(patternId, originalPath){
  initSupabase();
  const { data } = await supabase.auth.getSession();
  const token = data?.session?.access_token;
  if(!token) throw new Error('未登录或 token 为空');
  const url = `${SUPABASE_URL}/functions/v1/process-pattern-pdf`;
  const headers = { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token };
  const body = { patternId, originalFilePath: originalPath };
  setStatus('请求后端处理 PDF...', true);
  const resp = await fetch(url, { method:'POST', headers, body: JSON.stringify(body) });
  const j = await resp.json().catch(()=>({ status: resp.status, text: 'non-json' }));
  log('[process-pattern-pdf] resp', j);
  setStatus('', false);
  return j;
}

/* get-signed-pdf wrapper */
async function getSignedPdfForPattern(patternId, expiresSec = 300){
  initSupabase();
  const { data } = await supabase.auth.getSession();
  const token = data?.session?.access_token;
  if(!token) { alert('请先登录'); return; }
  const url = `${SUPABASE_URL}/functions/v1/get-signed-pdf`;
  const headers = { 'Content-Type':'application/json', 'Authorization':'Bearer ' + token };
  const body = { patternId, expires_sec: expiresSec };
  setStatus('获取签名下载链接...', true);
  const resp = await fetch(url, { method:'POST', headers, body: JSON.stringify(body) });
  const j = await resp.json().catch(()=>({ status: resp.status, text: 'non-json' }));
  log('[get-signed-pdf] resp', j);
  setStatus('', false);
  return j;
}

/* ===== Helper to load materials / tutorials for a pattern ===== */
async function loadMaterialsForPattern(pid){
  try {
    if(!pid) return;
    initSupabase();
    setBusyUI(true, '加载该纸样的材料...');
    const { data, error } = await supabase.from('pattern_materials').select('*').eq('pattern_id', pid).order('seq', { ascending:true });
    setBusyUI(false);
    if(error){ log('load materials for pattern err', error); alert('加载材料失败: ' + error.message); return; }
    // replace current material rows
    materialsTbody.innerHTML = '';
    if(!data || data.length === 0){
      ensureFiveRows(); // keep 5 blank rows
      return;
    }
    data.forEach(d => addMaterialRow(d));
    refreshMaterialIndexes();
  } catch(e){
    setBusyUI(false);
    log('loadMaterialsForPattern exception', e);
    alert('加载材料异常: ' + e.message);
  }
}

async function loadTutorialsForPattern(pid){
  try {
    if(!pid) return;
    initSupabase();
    setBusyUI(true, '加载该纸样的教程...');
    const { data, error } = await supabase.from('tutorial_media').select('*').eq('pattern_id', pid).order('seq', { ascending:true });
    setBusyUI(false);
    if(error){ log('load tutorials for pattern err', error); tutorialsList.innerHTML = `<div class="muted">加载失败: ${error.message}</div>`; return; }
    tutorialsList.innerHTML = '';
    if(!data || data.length === 0){ tutorialsList.innerHTML = '<div class="muted">暂无教程</div>'; return; }
    const wrap = document.createElement('div');
    data.forEach(d => {
      const el = document.createElement('div');
      el.innerHTML = `<strong>[${d.media_type}] ${d.title || ''}</strong>
        <div>${d.body ? d.body : ''}</div>
        <div>${d.media_path ? '<a target="_blank" class="link" href="' + (SUPABASE_URL.replace('/.co','') + '/storage/v1/object/public/' + d.media_path) + '">打开媒体 (Storage)</a>' : ''}</div><hr/>`;
      wrap.appendChild(el);
    });
    tutorialsList.appendChild(wrap);
  } catch(e){
    setBusyUI(false);
    log('loadTutorialsForPattern exception', e);
    tutorialsList.innerHTML = `<div class="muted">异常: ${e.message}</div>`;
  }
}

/* ===== UI flows ===== */
/* 上传纸样（创建 pattern + 上传原始 PDF + 触发处理） */
createAndUploadBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    const file = pdfFileInput.files[0];
    const title = (titleInput.value||'').trim();
    const desc = (descInput.value||'').trim();
    if(!title) return alert('请填写纸样标题');
    if(!file) return alert('请选择 PDF 文件（不超过50MB）');
    if(file.size > MAX_FILE_BYTES) return alert('文件超过50MB，无法上传');

    setBusyUI(true, '创建 pattern 并上传纸样...');
    const pattern = await callCreatePattern(title, desc);
    log('[UI] pattern created', pattern);
    // store editingPatternId internally (hidden)
    editingPatternId = pattern.id;
    updateActionButtonsState();

    setStatus('上传原始 PDF...', true);
    const originalPath = await uploadFileViaServerXHR(pattern.id, file, /*bucket*/ null);
    log('[UI] originalPath', originalPath);

    setStatus('触发后端处理...', true);
    const proc = await callProcessPatternPdfWithPath(pattern.id, originalPath);

    processedInfo.innerHTML = `<div><strong>后端返回：</strong><pre>${JSON.stringify(proc, null, 2)}</pre></div>`;
    const signedUrl = proc?.signedUrl || proc?.signed_url || proc?.signed || proc?.downloadUrl;
    const processedPath = proc?.processedPath || proc?.processed_path || proc?.path || proc?.processed_pdf_path || proc?.processed;
    if(signedUrl){
      processedInfo.innerHTML = `<div>处理完成 — 直接下载： <a class="link" target="_blank" href="${signedUrl}">下载处理后 PDF</a></div>`;
    } else if(processedPath){
      processedInfo.innerHTML = `<div>处理完成 — 存储路径：<code>${processedPath}</code></div>
        <div style="margin-top:8px;"><button id="getSignedForProcessed">获取处理后 PDF 的 Signed URL 并打开</button></div>`;
      document.getElementById('getSignedForProcessed').addEventListener('click', async () => {
        setBusyUI(true, '获取签名链接...');
        const j = await getSignedPdfForPattern(pattern.id, 300);
        setBusyUI(false);
        log('[get-signed-pdf after processedPath] ', j);
        if(!j.ok){ alert('获取签名链接失败: ' + (j.error || JSON.stringify(j))); return; }
        const su = j.signedUrl || j.signed_url || j.signed || j.downloadUrl;
        if(!su){ alert('后端返回但未包含 signedUrl'); return; }
        processedInfo.innerHTML = `<div>Signed URL (expires ${j.expires_sec || 300}s): <a target="_blank" class="link" href="${su}">下载处理后 PDF</a></div>`;
        window.open(su, '_blank');
      });
    } else {
      log('[UI] process response no recognized link');
    }

    // show save button since we are now editing this pattern
    savePatternChangesBtn.style.display = 'inline-block';
    updateActionButtonsState();

    // after creating, auto-load materials & tutorials for this pattern
    await loadMaterialsForPattern(editingPatternId);
    await loadTutorialsForPattern(editingPatternId);

    await loadPatterns();
    processedInfo.scrollIntoView({ behavior: 'smooth' });
    setBusyUI(false);
  } catch (e) {
    setBusyUI(false);
    resetUploadProgress();
    log('[UI] create+upload error', e);
    alert('错误: ' + (e.message || JSON.stringify(e)));
  }
});

/* 保存对已选 paper 的修改（仅 title & description） */
savePatternChangesBtn.addEventListener('click', async () => {
  try {
    if(!editingPatternId) return alert('请先选择或创建一个 paper（点击列表的“编辑”或先上传）');
    const newTitle = (titleInput.value||'').trim();
    const newDesc = (descInput.value||'').trim();
    if(!newTitle) return alert('标题不能为空');
    setBusyUI(true, '保存修改中...');
    const { data, error } = await supabase.from('patterns').update({
      title: newTitle,
      description: newDesc
    }).eq('id', editingPatternId).select();
    setBusyUI(false);
    if(error){ log('save edited pattern err', error); alert('保存失败: ' + error.message); return; }
    alert('保存成功');
    // refresh list and keep editing id
    await loadPatterns();
    updateActionButtonsState();
  } catch(e){
    setBusyUI(false);
    log('save edited pattern exception', e);
    alert('保存异常: ' + e.message);
  }
});

/* tutorial type single-select behaviour (show/hide file input) */
function getSelectedTutorialType(){
  const radios = document.querySelectorAll('input[name="tutType"]');
  for(const r of radios) if(r.checked) return r.value;
  return 'text';
}
tutorialTypeRow.addEventListener('change', () => {
  const sel = getSelectedTutorialType();
  if(sel === 'text' || sel === 'external_link'){
    tutorialLink.style.display = 'block';
    tutorialFile.style.display = 'none';
  } else {
    tutorialLink.style.display = 'none';
    tutorialFile.style.display = 'block';
  }
});

// tutorial upload flow: file types limited to 50MB
uploadTutorialBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    if(!editingPatternId) return alert('请先创建或选择一个纸样（点击右侧列表的 编辑）');
    const pid = editingPatternId;
    const type = getSelectedTutorialType();
    const title = (tutorialTitle.value||'').trim();
    let body = (tutorialLink.value||'').trim();
    let media_path = null;

    setBusyUI(true, '上传教程媒体...');
    if(type === 'external_link'){
      if(!body) { setBusyUI(false); return alert('请填写外部链接'); }
      media_path = body;
    } else if(type === 'text'){
      if(!body) { setBusyUI(false); return alert('请填写文本内容'); }
    } else {
      const f = tutorialFile.files[0];
      if(!f) { setBusyUI(false); return alert('请选择文件上传'); }
      if(f.size > MAX_FILE_BYTES){ setBusyUI(false); return alert('文件超过50MB，无法上传'); }
      const path = await uploadFileViaServerXHR(pid, f, 'patterns-assets');
      media_path = path;
    }

    const seq = 0;
    const row = { pattern_id: pid, seq, media_type: type, title, body: type==='text'?body:null, media_path: media_path||null };
    log('insert tutorial_media', row);
    const { data, error } = await supabase.from('tutorial_media').insert([row]).select();
    if(error){ setBusyUI(false); log('tutorial insert err', error); alert('插入失败: ' + error.message); return; }
    setBusyUI(false);
    alert('教程媒体保存成功');
    // reload tutorials list
    await loadTutorialsForPattern(pid);
  } catch(e){
    setBusyUI(false);
    log('upload tutorial err', e);
    alert('错误: ' + (e.message || JSON.stringify(e)));
  }
});

/* list tutorials (button) */
listTutorialsBtn.addEventListener('click', async () => {
  if(!editingPatternId) return alert('请先选择或创建纸样（右侧列表 编辑 / 上传后自动成为当前编辑）');
  await loadTutorialsForPattern(editingPatternId);
});

/* ===== Materials UI improvements ===== */
let matIdCounter = 0;
function addMaterialRow(data = {}) {
  const id = `m${matIdCounter++}`;
  const tr = document.createElement('tr');
  tr.dataset.matId = id;
  tr.innerHTML = `
    <td>${materialsTbody.children.length + 1}</td>
    <td><input data-key="name" placeholder="名称" value="${(data.name||'').replace(/"/g,'&quot;')}" /></td>
    <td><input data-key="qty" placeholder="数量" value="${(data.qty||'')}" /></td>
    <td><input data-key="note" placeholder="备注" value="${(data.note||'').replace(/"/g,'&quot;')}" /></td>
    <td><input data-key="link" placeholder="链接 (可选)" value="${(data.link||'').replace(/"/g,'&quot;')}" /></td>
    <td class="mat-actions"><button class="ghost del">删除</button></td>
  `;
  materialsTbody.appendChild(tr);
  tr.querySelector('button.del').addEventListener('click', () => { tr.remove(); refreshMaterialIndexes(); });
}
function refreshMaterialIndexes(){ Array.from(materialsTbody.children).forEach((tr, idx) => { tr.children[0].textContent = (idx+1).toString(); }); }

/* ensureFiveRows is now a real function so we can call it */
function ensureFiveRows(){
  if(materialsTbody.children.length === 0){
    for(let i=0;i<5;i++) addMaterialRow();
  }
}

// add default 5 rows initially (露出五行)
addMaterialBtn.addEventListener('click', () => addMaterialRow());
ensureFiveRows();

// 保存材料（pattern_materials） — 仍然按 pattern_id 保存
saveMaterialsBtn.addEventListener('click', async () => {
  try {
    initSupabase();
    if(!editingPatternId) return alert('请先选择或创建一个纸样（右侧列表 编辑 / 上传后自动成为当前编辑）');
    const pid = editingPatternId;
    const rows = [];
    Array.from(materialsTbody.children).forEach((tr, idx) => {
      const name = tr.querySelector('input[data-key="name"]').value.trim();
      const qty = tr.querySelector('input[data-key="qty"]').value.trim();
      const note = tr.querySelector('input[data-key="note"]').value.trim();
      const link = tr.querySelector('input[data-key="link"]').value.trim();
      if(!name) return;
      rows.push({ pattern_id: pid, seq: idx, name, qty, note, link });
    });
    if(rows.length === 0) return alert('没有可保存的材料行');
    setBusyUI(true, '保存材料...');
    const { data, error } = await supabase.from('pattern_materials').insert(rows).select();
    setBusyUI(false);
    if(error){ log('insert materials err', error); alert('插入失败:' + error.message); return; }
    alert('材料保存成功: ' + data.length + ' 行');
    // after save, reload materials from server to reflect any DB defaults/ids
    await loadMaterialsForPattern(pid);
  } catch(e){ setBusyUI(false); log('save materials err', e); alert('错误: ' + e.message); }
});

/* “从材料库里添加” —— 改为：加载该纸样已保存的 pattern_materials 并显示（替代旧的 materials_library 行为） */
loadMaterialsBtn.addEventListener('click', async () => {
  try {
    if(!editingPatternId) return alert('请先选择或创建一个纸样，然后再加载该纸样已保存的材料。');
    await loadMaterialsForPattern(editingPatternId);
    alert('已加载该纸样的已保存材料。');
  } catch(e){
    log('load materials for pattern (button) err', e);
    alert('加载已保存材料出错: ' + (e.message || e));
  }
});

/* ===== Patterns list (compact) ===== */
refreshPatternsBtn.addEventListener('click', loadPatterns);
newPatternFocusBtn.addEventListener('click', () => { titleInput.focus(); });

async function loadPatterns(){
  try {
    if(!supabase) initSupabase();
    if(!currentUser) { patternsTbody.innerHTML = '<tr><td colspan="3" class="mutedCell">请先登录以查看你的纸样</td></tr>'; return; }
    setBusyUI(true, '加载我的纸样...');
    const { data, error } = await supabase.from('patterns').select('*').eq('designer_id', currentUser.id).order('created_at', { ascending:false }).limit(200);
    setBusyUI(false);
    if(error){ log('load patterns error', error); patternsTbody.innerHTML = `<tr><td colspan="3">加载失败: ${error.message}</td></tr>`; return; }
    renderPatternsCompact(data || []);
  } catch(e){ setBusyUI(false); log('load patterns exception', e); patternsTbody.innerHTML = `<tr><td colspan="3">异常: ${e.message}</td></tr>`; }
}

function renderPatternsCompact(arr){
  patternsTbody.innerHTML = '';
  if(!arr || arr.length === 0) {
    patternsTbody.innerHTML = '<tr><td colspan="3" class="mutedCell">尚无记录（创建后会显示在此）</td></tr>';
    return;
  }
  arr.forEach((p, idx) => {
    const tr = document.createElement('tr');
    const displayTitle = (p.title || '-').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    tr.innerHTML = `
      <td style="width:18px">${idx+1}</td>
      <td style="padding-right:8px;"><div style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${displayTitle}</div></td>
      <td style="text-align:right">
        <div class="pat-actions">
          <button class="ghost tinyBtn btn-edit" title="编辑">编辑</button>
          <button class="ghost tinyBtn btn-download" title="下载">下载</button>
        </div>
      </td>
    `;
    // edit: fill left form (no Pattern ID shown) and load materials/tutorials
    tr.querySelector('.btn-edit').addEventListener('click', async () => {
      titleInput.value = p.title || '';
      descInput.value = p.description || '';
      editingPatternId = p.id;
      savePatternChangesBtn.style.display = 'inline-block';
      updateActionButtonsState();
      titleInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      log('[UI] editing pattern', p.id);
      // load materials and tutorials for this pattern
      await loadMaterialsForPattern(editingPatternId);
      await loadTutorialsForPattern(editingPatternId);
    });
    // download: try immediate signed url request
    tr.querySelector('.btn-download').addEventListener('click', async () => {
      try {
        setBusyUI(true, '获取签名链接...');
        const j = await getSignedPdfForPattern(p.id, 300);
        setBusyUI(false);
        log('[patterns] getsigned resp', j);
        if(!j || !j.ok){ alert('获取签名链接失败: ' + (j?.error || JSON.stringify(j))); return; }
        const su = j.signedUrl || j.signed_url || j.signed || j.downloadUrl;
        if(!su){ alert('后端返回但未包含 signedUrl'); return; }
        window.open(su, '_blank');
      } catch(e){ setBusyUI(false); log('get signed error', e); alert('签名获取失败: ' + e.message); }
    });

    patternsTbody.appendChild(tr);
  });
}

/* ===== URL / magic link handling (自动处理验证链接返回：token 或 错误) =====
   说明：
   - Supabase 的 verify 链接会把用户引导至 auth 服务再 redirectTo 回你的页面。
   - 回到页面时，info 可能在 location.hash（常见），也可能在 query string。
   - 我们尝试解析 access_token/refresh_token 并用 setSession 设置会话；若有 error 则友好提示。
*/
function parseParamsFromHashOrSearch() {
  const res = {};
  const hashPart = (window.location.hash || '').replace(/^#/, '');
  const searchPart = (window.location.search || '').replace(/^\?/, '');
  const p = new URLSearchParams(hashPart || searchPart);
  for (const [k, v] of p.entries()) res[k] = v;
  return res;
}

async function tryHandleAuthFromUrl() {
  try {
    initSupabase();
    const params = parseParamsFromHashOrSearch();
    // If there is an access_token returned by Supabase (magic link flow)
    if (params.access_token) {
      const access_token = params.access_token;
      const refresh_token = params.refresh_token || null;
      try {
        // setSession will store tokens client-side
        const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
        if (error) {
          log('[Auth] setSession error', error);
        } else {
          log('[Auth] setSession success', data);
        }
      } catch (e) {
        log('[Auth] setSession exception', e);
      }
      // 清理 URL（移除隐私敏感 token）
      const cleanUrl = window.location.origin + window.location.pathname + window.location.search;
      window.history.replaceState({}, document.title, cleanUrl);
      // 更新 UI（如果取得 session）
      const { data: sessionData } = await supabase.auth.getSession();
      if (sessionData?.session?.user) {
        updateUserInfo(sessionData.session.user);
        alert('已自动登录。');
        return;
      }
    }

    // 如果返回了 error（例如 otp_expired），提示用户
    if (params.error) {
      const err = params.error;
      const desc = params.error_description ? decodeURIComponent(params.error_description) : '';
      // 清理 URL
      const cleanUrl = window.location.origin + window.location.pathname + window.location.search;
      window.history.replaceState({}, document.title, cleanUrl);

      if (err === 'access_denied' && desc && desc.toLowerCase().includes('expired')) {
        alert('验证链接已过期或无效。请返回应用重新发起注册流程。');
      } else {
        alert('邮箱验证/登录链接返回错误：' + (desc || err));
      }
      return;
    }

    // 某些配置会返回 type=signup 表示刚刚完成邮箱验证（无 token）
    if (params.type && params.type.toLowerCase().includes('signup')) {
      const cleanUrl = window.location.origin + window.location.pathname + window.location.search;
      window.history.replaceState({}, document.title, cleanUrl);
      alert('邮箱验证完成。请使用「登录」输入邮箱与密码进行登录');
      return;
    }

    // fallback: 如果已经有 session 则更新 UI
    const { data } = await supabase.auth.getSession();
    if (data?.session?.user) updateUserInfo(data.session.user);
  } catch (e) {
    log('tryHandleAuthFromUrl exception', e);
  }
}

/* initial housekeeping: init supabase, try handle auth from url, then subscribe */
await initSupabase();
await tryHandleAuthFromUrl();
await updateUserInfoPeriodically();
setStatus('', false);

/* initial patterns & materials state */
if(materialsTbody.children.length === 0) ensureFiveRows();
updateActionButtonsState();

</script>
</body>
</html>
