<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>设计师 - 编辑纸样</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --accent:#0f766e; --muted:#6b7280; --card:#fff; --radius:12px; --shadow:0 6px 18px rgba(15,23,42,0.06); }
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:linear-gradient(180deg,#f3f6fb,#eef2f6); color:#0b1220;}
    .wrap{max-width:1100px;margin:28px auto;padding:18px;}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px;}
    h1{margin:0;font-size:18px;}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);border:1px solid rgba(15,23,42,0.04);}
    label{display:block;font-weight:600;margin-top:12px;font-size:13px;}
    input[type="text"],textarea,select,input[type="file"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e8eb;box-sizing:border-box;margin-top:6px;background:#fff;}
    textarea{min-height:80px;resize:vertical;}
    .row{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;align-items:center;}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(15,118,110,0.12);}
    button.small{padding:6px 8px;font-size:13px;}
    .muted{color:var(--muted);font-size:13px;}
    .fileName{padding:8px 10px;background:#fafafa;border-radius:8px;border:1px dashed #eee;display:flex;justify-content:space-between;align-items:center;}
    .materialsWrap{overflow:auto;margin-top:10px;}
    table.mat{width:100%;border-collapse:collapse;font-size:13px;}
    table.mat th,table.mat td{padding:8px 6px;border-bottom:1px solid #f0f2f4;vertical-align:middle;}
    table.mat th{font-weight:700;color:var(--muted);font-size:12px;}
    .mat-actions{display:flex;gap:8px;}
    tr.dragging{opacity:0.4}
    /* modal */
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:2000}
    .modal{background:#fff;border-radius:12px;padding:16px;max-width:720px;width:100%;box-shadow:0 10px 40px rgba(2,6,23,0.3);}
    .lib-list{max-height:320px;overflow:auto;border:1px solid #f0f2f4;padding:8px;border-radius:8px;}
    .lib-item{display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid #f7f8f9;}
    .topbar-actions{display:flex;gap:8px;align-items:center;}
    .rightTop{display:flex;gap:8px;align-items:center;}
    a.link{color:#0ea5a3;text-decoration:none;font-weight:600;}
    .smallNote{font-size:12px;color:var(--muted)}
    /* small progress "indeterminate" animation by pulsing width */
    @keyframes indeterminate { 0%{transform:translateX(-100%);} 100%{transform:translateX(100%);} }
    .indeterminate-wrap {position:relative; width:100%; height:10px; background:#e6eef0; border-radius:999px; overflow:hidden;}
    .indeterminate-bar {position:absolute; left:-40%; top:0; height:100%; width:40%; background:linear-gradient(90deg,#0f766e,#0ea5a3); animation: indeterminate 1.2s linear infinite;}
    /* overlay */
    .overlay { position: fixed; left:0; top:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:3000; }
    .overlay .pane{ background: rgba(255,255,255,0.85); padding:18px 20px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.2); display:flex; gap:12px; align-items:center; }
    .spinner { width:18px; height:18px; border-radius:50%; border:3px solid rgba(0,0,0,0.08); border-top-color:var(--accent); animation:spin 1s linear infinite; }
    @keyframes spin { to{ transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>纸样</h1>
        <div class="muted smallNote">填写纸样信息并上传 PDF，完善材料和教程信息。</div>
      </div>
      <div class="rightTop">
        <button id="backToList" class="ghost small">返回列表</button>
        <div id="accountArea" class="muted"></div>
      </div>
    </header>

    <div class="card" id="paperCard">
      <h3 style="margin:0 0 8px 0;">纸样信息</h3>
      <label>纸样名称</label>
      <input id="titleInput" type="text" placeholder="纸样名称" />

      <label>纸样描述</label>
      <textarea id="descInput" placeholder="简短描述..."></textarea>

      <label>当前已上传的 PDF</label>
      <div id="currentFileWrap" class="fileName">未选择文件 <span id="currentFileName" style="margin-left:8px"></span></div>

      <label style="margin-top:10px">上传/替换 PDF（选择则替换，≤50MB）</label>
      <div class="row">
        <input id="pdfFile" type="file" accept="application/pdf" />
        <div style="flex:1"></div>
        <button id="uploadAndProcessBtn">上传并保存纸样</button>
      </div>

      <div id="uploadProgressWrap" style="display:none;margin-top:10px">
        <div class="muted" id="uploadStatusText">上传进度</div>
        <div id="uploadProgressBar" style="margin-top:6px;">
          <div style="height:10px;background:#e6eef0;border-radius:999px;overflow:hidden;">
            <div id="uploadBar" style="height:100%;width:0%;background:linear-gradient(90deg,#0f766e,#0ea5a3);transition:width .2s"></div>
          </div>
        </div>
        <div class="muted" id="uploadPct">0%</div>
      </div>

      <div id="processedInfo" style="margin-top:12px;"></div>
    </div>

    <div class="card" style="margin-top:16px;" id="materialsCard">
      <h3 style="margin:0 0 8px 0;">材料清单</h3>
      <div class="row">
        <button id="addMaterialBtn" class="ghost small">+ 新增行</button>
        <button id="loadMaterialsBtn" class="ghost small">从材料库里添加</button>
        <button id="saveMaterialsBtn" class="ghost small">保存材料</button>
        <div style="flex:1"></div>
        <div class="muted">提示：拖拽行以调整顺序</div>
      </div>

      <div class="materialsWrap">
        <table class="mat" id="materialsTable">
          <thead><tr><th style="width:40px">#</th><th>名称</th><th style="width:100px">数量</th><th>备注</th><th style="width:180px">链接</th><th style="width:80px">动作</th></tr></thead>
          <tbody id="materialsTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:16px;" id="tutorialCard">
      <h3 style="margin:0 0 8px 0;">教程文件</h3>

      <label>教程名称</label>
      <input id="tutorialTitle" type="text" placeholder="教程标题" />

      <label>类型</label>
      <div style="display:flex;gap:12px;margin-top:6px;">
        <label><input type="radio" name="tutType" value="text" checked> 文本</label>
        <label><input type="radio" name="tutType" value="pdf"> PDF（上传）</label>
        <label><input type="radio" name="tutType" value="image"> 图片（上传）</label>
        <label><input type="radio" name="tutType" value="video"> 视频（上传）</label>
        <label><input type="radio" name="tutType" value="external_link"> 外部链接</label>
      </div>

      <label id="tutorialBodyLabel" style="margin-top:10px;">外链 / 文本 / 文件</label>
      <input id="tutorialLink" type="text" placeholder="外部链接或简短说明" style="display:block;margin-bottom:8px;" />
      <input id="tutorialFile" type="file" style="display:none" />

      <div class="row">
        <button id="uploadTutorialBtn">上传教程</button>
        <button id="listTutorialsBtn" class="ghost">列出教程</button>
        <div style="flex:1"></div>
      </div>

      <div id="tutorialsList" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- materials modal -->
  <div id="libModal" style="display:none;">
    <div class="modal-backdrop" id="libBackdrop">
      <div class="modal card">
        <h3>材料库（历史材料）</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
          <button id="libRefreshBtn" class="ghost small">刷新</button>
          <div style="flex:1"></div>
          <button id="libAddSelectedBtn">添加选中到当前纸样</button>
          <button id="libCloseBtn" class="ghost">关闭</button>
        </div>
        <div class="lib-list" id="libList"></div>
      </div>
    </div>
  </div>

  <!-- overlay -->
  <div id="overlay" class="overlay"><div class="pane"><div class="spinner"></div><div id="overlayText" class="muted">处理中…</div></div></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ====== CONFIG ====== */
const SUPABASE_URL = "https://fdxvtmgmmrpdkwhrbsfl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkeHZ0bWdtbXJwZGt3aHJic2ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzY0NTUsImV4cCI6MjA3NDkxMjQ1NX0.iU-T3S8OzgGSXtbIf6D7WsMAaIXKNqZE8ooScS4udEk";
const MAX_FILE_BYTES = 50 * 1024 * 1024;

// If uploaded paths returned by your functions do NOT include bucket, we will prepend DEFAULT_PUBLIC_BUCKET
// Change this to the bucket your functions actually upload to (e.g. 'patterns-originals' or 'your-bucket-name')
const DEFAULT_PUBLIC_BUCKET = "patterns-originals";
const KNOWN_BUCKETS = [ "patterns-originals", "patterns-assets", "public" ];

let supabase = null;
let currentUser = null;
let editingPatternId = null;
let currentPattern = null; // full pattern object loaded
let matIdCounter = 0;

/* DOM */
const titleInput = document.getElementById('titleInput');
const descInput = document.getElementById('descInput');
const pdfFileInput = document.getElementById('pdfFile');
const currentFileName = document.getElementById('currentFileName');
const currentFileWrap = document.getElementById('currentFileWrap');
const uploadAndProcessBtn = document.getElementById('uploadAndProcessBtn');
const uploadProgressWrap = document.getElementById('uploadProgressWrap');
const uploadBar = document.getElementById('uploadBar');
const uploadPct = document.getElementById('uploadPct');
const uploadStatusText = document.getElementById('uploadStatusText');
const processedInfo = document.getElementById('processedInfo');

const addMaterialBtn = document.getElementById('addMaterialBtn');
const saveMaterialsBtn = document.getElementById('saveMaterialsBtn');
const loadMaterialsBtn = document.getElementById('loadMaterialsBtn');
const materialsTbody = document.getElementById('materialsTbody');

const tutorialTitle = document.getElementById('tutorialTitle');
const tutorialLink = document.getElementById('tutorialLink');
const tutorialFile = document.getElementById('tutorialFile');
const uploadTutorialBtn = document.getElementById('uploadTutorialBtn');
const listTutorialsBtn = document.getElementById('listTutorialsBtn');
const tutorialsList = document.getElementById('tutorialsList');

const backToList = document.getElementById('backToList');
const accountArea = document.getElementById('accountArea');

const libModal = document.getElementById('libModal');
const libBackdrop = document.getElementById('libBackdrop');
const libList = document.getElementById('libList');
const libRefreshBtn = document.getElementById('libRefreshBtn');
const libCloseBtn = document.getElementById('libCloseBtn');
const libAddSelectedBtn = document.getElementById('libAddSelectedBtn');
const libClearCacheBtn = document.getElementById('libClearCacheBtn');

const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');

init();

async function init(){
  supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const { data } = await supabase.auth.getSession();
  if(data?.session?.user){
    currentUser = data.session.user;
    accountArea.innerHTML = `<a href="login.html" class="link" id="accountLink">${currentUser.email || currentUser.id}</a>`;
    document.getElementById('accountLink').addEventListener('click', (e)=>{ e.preventDefault(); window.location.href='login.html'; });
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if(id) {
      editingPatternId = id;
      await loadPatternForEdit(id);
    } else {
      editingPatternId = null;
      ensureFiveRows();
    }
  } else {
    window.location.href = 'login.html';
    return;
  }

  // events
  pdfFileInput.addEventListener('change', onPdfSelected);
  addMaterialBtn.addEventListener('click', ()=>addMaterialRow());
  saveMaterialsBtn.addEventListener('click', saveMaterials);
  loadMaterialsBtn.addEventListener('click', openMaterialsModal);

  uploadAndProcessBtn.addEventListener('click', onUploadAndProcess);
  backToList.addEventListener('click', ()=>location.href = 'index.html');

  document.querySelectorAll('input[name="tutType"]').forEach(r => r.addEventListener('change', onTutorialTypeChange));
  onTutorialTypeChange();

  uploadTutorialBtn.addEventListener('click', onUploadTutorial);
  listTutorialsBtn.addEventListener('click', ()=> loadTutorialsForPattern(editingPatternId));

  libCloseBtn.addEventListener('click', closeMaterialsModal);
  libRefreshBtn.addEventListener('click', fetchMaterialsLibraryAndRender);
  libAddSelectedBtn.addEventListener('click', addSelectedLibToMaterials);
  libClearCacheBtn.addEventListener('click', ()=>{ localStorage.removeItem('materials_library_cache'); fetchMaterialsLibraryAndRender(); });

  // drag/drop handlers delegated
  materialsTbody.addEventListener('dragstart', matDragStart);
  materialsTbody.addEventListener('dragover', matDragOver);
  materialsTbody.addEventListener('drop', matDrop);
  materialsTbody.addEventListener('dragend', matDragEnd);

  ensureFiveRows();
}

/* ---------- Overlay helpers ---------- */
function showOverlay(text){
  overlayText.textContent = text || '处理中…';
  overlay.style.display = 'flex';
}
function hideOverlay(){
  overlay.style.display = 'none';
}

/* ---------- Helpers ---------- */
function setUploadProgress(pct){
  uploadProgressWrap.style.display = 'block';
  uploadBar.style.width = Math.max(0, Math.min(100, Math.round(pct))) + '%';
  uploadPct.textContent = Math.round(pct) + '%';
  uploadStatusText.textContent = '上传进度';
  uploadAndProcessBtn.disabled = true;
}
function setProcessingState(on){
  if(on){
    uploadProgressWrap.style.display = 'block';
    const wrap = document.getElementById('uploadProgressBar');
    wrap.innerHTML = `<div class="indeterminate-wrap"><div class="indeterminate-bar"></div></div>`;
    uploadPct.textContent = '处理中…';
    uploadStatusText.textContent = '数据处理中';
    uploadAndProcessBtn.disabled = true;
  } else {
    const wrap = document.getElementById('uploadProgressBar');
    wrap.innerHTML = `<div style="height:10px;background:#e6eef0;border-radius:999px;overflow:hidden;">
      <div id="uploadBar" style="height:100%;width:0%;background:linear-gradient(90deg,#0f766e,#0ea5a3);transition:width .2s"></div>
    </div>`;
    uploadPct.textContent = '0%';
    uploadStatusText.textContent = '上传进度';
    uploadAndProcessBtn.disabled = false;
  }
}

function log(msg, obj){ console.log(msg, obj||''); }

/* build public url: handle missing bucket by prepending DEFAULT_PUBLIC_BUCKET */
function getPublicUrl(path){
  if(!path) return '';
  const s = String(path).trim();
  if(!s) return '';
  if(s.startsWith('http://') || s.startsWith('https://')) return s;
  const cleaned = s.replace(/^\/+/, '');
  const firstSeg = cleaned.split('/')[0];
  let bucket = null;
  if(KNOWN_BUCKETS.includes(firstSeg)) {
    // path already contains bucket
    return `${SUPABASE_URL.replace(/\/$/, '')}/storage/v1/object/public/${cleaned}`;
  } else {
    // prepend default bucket
    const withBucket = `${DEFAULT_PUBLIC_BUCKET}/${cleaned}`;
    return `${SUPABASE_URL.replace(/\/$/, '')}/storage/v1/object/public/${withBucket}`;
  }
}

async function authHeaders(){
  const { data } = await supabase.auth.getSession();
  const token = data?.session?.access_token;
  return { 'Content-Type':'application/json', 'Authorization': token ? ('Bearer ' + token) : '' };
}

/* ---------- Pattern load & edit ---------- */
async function loadPatternForEdit(id){
  try {
    showOverlay('加载纸样...');
    const { data, error } = await supabase.from('patterns').select('*').eq('id', id).single();
    hideOverlay();
    if(error){ alert('加载纸样失败: ' + error.message); return; }
    currentPattern = data;
    editingPatternId = data.id;
    titleInput.value = data.title || '';
    descInput.value = data.description || '';
    if(data.original_pdf_name) currentFileName.textContent = data.original_pdf_name;
    else if(data.original_pdf_path) {
      const seg = data.original_pdf_path.split('/').pop();
      currentFileName.textContent = seg || data.original_pdf_path;
    } else {
      currentFileName.textContent = '未上传';
    }
    renderProcessedInfoFromPattern(data);
    await loadMaterialsForPattern(editingPatternId);
    await loadTutorialsForPattern(editingPatternId);
  } catch(e){
    hideOverlay();
    alert('加载纸样异常: ' + (e.message || e));
  }
}

function renderProcessedInfoFromPattern(p){
  processedInfo.innerHTML = '';
  if(!p) return;
  if(p.processed_pdf_path){
    const pub = getPublicUrl(p.processed_pdf_path);
    // const a = document.createElement('a'); a.href = pub; a.target = '_blank'; a.textContent = '打开处理后 PDF（公开路径）'; a.className = 'link';
    // processedInfo.appendChild(a);

    const btn = document.createElement('button'); btn.className = 'ghost small'; btn.style.marginLeft = '8px'; btn.textContent = '查看处理后纸样';
    btn.addEventListener('click', async ()=>{
      try {
        showOverlay('获取签名链接...');
        const j = await getSignedPdfForPattern(p.id, 300);
        hideOverlay();
        if(!j || !(j.ok || j.success)) return alert('获取签名失败: ' + (j?.error || JSON.stringify(j)));
        const su = j.signedUrl || j.signed_url || j.downloadUrl || j.signed;
        if(!su) return alert('后端未返回 signedUrl');
        window.open(su, '_blank');
      } catch(err){ hideOverlay(); alert('获取签名失败: ' + (err.message || err)); }
    });
    processedInfo.appendChild(btn);
  }
}

/* ---------- PDF selection ---------- */
pdfFileInput.addEventListener('change', onPdfSelected);
function onPdfSelected(){
  const f = pdfFileInput.files[0];
  if(!f){ currentFileName.textContent = currentPattern?.original_pdf_name || '未选择'; return; }
  if(f.size > MAX_FILE_BYTES){ alert('文件过大（>50MB）'); pdfFileInput.value = ''; return; }
  currentFileName.textContent = f.name + '（将替换）';
}

/* ---------- Create / Upload & Process flow ---------- */
async function onUploadAndProcess(){
  try {
    uploadAndProcessBtn.disabled = true;
    setUploadProgress(0);
    showOverlay('开始上传/处理...');

    const title = (titleInput.value||'').trim();
    const desc = (descInput.value||'').trim();
    if(!title){ hideOverlay(); setProcessingState(false); uploadAndProcessBtn.disabled=false; return alert('请填写纸样标题'); }

    // 1) ensure pattern exists
    if(!editingPatternId){
      const headers = await authHeaders();
      const resp = await fetch(`${SUPABASE_URL}/functions/v1/create-pattern`, { method:'POST', headers, body: JSON.stringify({ title, description: desc }) });
      const j = await resp.json().catch(()=>({ ok:false, status:resp.status }));
      if(!j || !(j.ok || j.pattern)){
        hideOverlay(); uploadAndProcessBtn.disabled=false;
        return alert('无法创建纸样: ' + (j?.error || JSON.stringify(j)));
      }
      const pattern = j.pattern || (j.data && j.data[0]) || j;
      editingPatternId = pattern.id;
      currentPattern = pattern;
    } else {
      try {
        const { data, error } = await supabase.from('patterns').update({ title, description: desc, updated_at: new Date().toISOString() }).eq('id', editingPatternId).select().single();
        if(!error) currentPattern = data;
      } catch(e){ console.warn('update title/desc non-fatal', e); }
    }

    // 2) upload file if provided
    const f = pdfFileInput.files[0];
    let originalPath = currentPattern?.original_pdf_path || null;
    let originalName = currentPattern?.original_pdf_name || null;
    if(f){
      // upload via XHR with progress
      try {
        const uploadedPath = await uploadFileViaServerXHR(editingPatternId, f, null, (pct)=>{ setUploadProgress(pct); });
        originalPath = uploadedPath;
        originalName = f.name;
        try { await supabase.from('patterns').update({ original_pdf_path: originalPath, original_pdf_name: originalName, updated_at: new Date().toISOString() }).eq('id', editingPatternId); } catch(e){ console.warn('update original path warning', e); }
        currentFileName.textContent = originalName;
      } catch(upErr){
        hideOverlay();
        uploadAndProcessBtn.disabled=false;
        setProcessingState(false);
        return alert('上传失败: ' + (upErr.message || upErr));
      }
    }

    if(!originalPath){
      hideOverlay();
      uploadAndProcessBtn.disabled=false;
      return alert('无可处理的 PDF 路径（请先上传文件）');
    }

    // 3) Trigger backend processing
    setProcessingState(true);
    showOverlay('数据处理中，请稍候...');
    try {
      const procResp = await callProcessPatternPdfWithPath(editingPatternId, originalPath);
      renderProcResponse(procResp);
      const processedPath = procResp?.processedPath || procResp?.processed_path || procResp?.path || procResp?.processed;
      if(processedPath){
        try { await supabase.from('patterns').update({ processed_pdf_path: processedPath, updated_at: new Date().toISOString() }).eq('id', editingPatternId); currentPattern = currentPattern || {}; currentPattern.processed_pdf_path = processedPath; } catch(e){ console.warn('db update processed path warning', e); }
      }
      hideOverlay();
      alert('文件上传并处理成功');
    } catch(e){
      hideOverlay();
      console.error('process call err', e);
      alert('处理请求失败: ' + (e.message || JSON.stringify(e)));
    } finally {
      setProcessingState(false);
      uploadAndProcessBtn.disabled = false;
    }

    await loadMaterialsForPattern(editingPatternId);
    await loadTutorialsForPattern(editingPatternId);

  } catch(e){
    hideOverlay();
    setProcessingState(false);
    uploadAndProcessBtn.disabled = false;
    alert('上传/处理异常: ' + (e.message || JSON.stringify(e)));
  }
}

/* upload via server XHR to show progress */
function uploadFileViaServerXHR(patternId, file, bucket=null, progressCb){
  return new Promise((resolve,reject)=>{
    const xhr = new XMLHttpRequest();
    const url = `${SUPABASE_URL}/functions/v1/upload-via-server`;
    xhr.open('POST', url, true);
    supabase.auth.getSession().then(({ data })=>{
      const token = data?.session?.access_token;
      if(token) xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      xhr.setRequestHeader('apikey', SUPABASE_ANON_KEY);
      const form = new FormData();
      form.append('file', file, file.name);
      if(patternId) form.append('patternId', patternId);
      if(bucket) form.append('bucket', bucket);
      xhr.upload.onprogress = function(e){
        if(e.lengthComputable){
          const pct = (e.loaded / e.total) * 100;
          if(typeof progressCb === 'function') progressCb(pct);
        } else {
          if(typeof progressCb === 'function') progressCb(50);
        }
      };
      xhr.onload = function(){
        if(xhr.status >=200 && xhr.status <300){
          try {
            const j = JSON.parse(xhr.responseText || '{}');
            if(!j.ok) return reject(new Error('upload-via-server returned not ok: ' + JSON.stringify(j)));
            return resolve(j.path || j.data?.path || j);
          } catch(err){ return reject(new Error('parse upload response: ' + err.message)); }
        } else {
          return reject(new Error('upload http ' + xhr.status + ': ' + xhr.responseText));
        }
      };
      xhr.onerror = function(){ reject(new Error('network error')); };
      xhr.send(form);
    }).catch(err=>reject(err));
  });
}

/* call process-function; accept responses with ok:true or success:true */
async function callProcessPatternPdfWithPath(patternId, originalPath){
  const headers = await authHeaders();
  const resp = await fetch(`${SUPABASE_URL}/functions/v1/process-pattern-pdf`, {
    method:'POST',
    headers,
    body: JSON.stringify({ patternId, originalFilePath: originalPath })
  });
  const j = await resp.json().catch(()=>({ ok:false, status:resp.status }));
  const positive = j && (j.ok === true || j.success === true || j.success === 'true');
  if(!positive){
    throw new Error('process failed: ' + (j?.error || JSON.stringify(j)));
  }
  return j;
}

function renderProcResponse(proc){
  processedInfo.innerHTML = '';
  if(!proc){ processedInfo.textContent = '后端未返回数据'; return; }
  const pre = document.createElement('pre'); pre.textContent = JSON.stringify(proc, null, 2); processedInfo.appendChild(pre);

  const signed = proc?.signedUrl || proc?.signed_url || proc?.downloadUrl || proc?.signed;
  const processedPath = proc?.processedPath || proc?.processed_path || proc?.path || proc?.processed;

  const wrap = document.createElement('div'); wrap.style.marginTop = '8px';
  if(signed){
    const a = document.createElement('a'); a.href = signed; a.target='_blank'; a.className='link'; a.textContent='下载处理后 PDF（signed URL）'; wrap.appendChild(a);
  } else if(processedPath){
    const pub = getPublicUrl(processedPath);
    // const a = document.createElement('a'); a.href = pub; a.target='_blank'; a.className='link'; a.textContent='打开处理后文件（公开路径）'; wrap.appendChild(a);

    const btn = document.createElement('button'); btn.className='ghost small'; btn.style.marginLeft='8px'; btn.textContent='查看处理后纸样';
    btn.addEventListener('click', async ()=>{
      try {
        showOverlay('获取签名链接...');
        const j = await getSignedPdfForPattern(editingPatternId, 300);
        hideOverlay();
        if(!j || !(j.ok || j.success)) return alert('获取签名失败: ' + (j?.error || JSON.stringify(j)));
        const su = j.signedUrl || j.signed_url || j.downloadUrl || j.signed;
        if(!su) return alert('后端未返回 signedUrl');
        window.open(su, '_blank');
      } catch(err){ hideOverlay(); alert('获取签名失败: ' + (err.message || err)); }
    });
    wrap.appendChild(btn);
  } else {
    const note = document.createElement('div'); note.className='muted'; note.textContent='后端未返回可下载链接或路径'; wrap.appendChild(note);
  }

  if(proc.qrPath){
    // const p = document.createElement('div'); const pub = getPublicUrl(proc.qrPath);
    // p.innerHTML = `<div class="muted">QR 调试图: <a target="_blank" class="link" href="${pub}">${proc.qrPath}</a></div>`;
    // wrap.appendChild(p);
  }
  if(proc.qrErrors && proc.qrErrors.length>0){
    const err = document.createElement('div'); err.style.marginTop='6px'; err.innerHTML = `<div style="color:#b91c1c">QR 错误: ${escapeHtml(String(proc.qrErrors.join('; ')))}</div>`; wrap.appendChild(err);
  }
  processedInfo.appendChild(wrap);
}

/* get-signed-pdf */
async function getSignedPdfForPattern(patternId, expires = 300){
  const headers = await authHeaders();
  const resp = await fetch(`${SUPABASE_URL}/functions/v1/get-signed-pdf`, {
    method:'POST',
    headers,
    body: JSON.stringify({ patternId, expires_sec: expires })
  });
  const j = await resp.json().catch(()=>({ ok:false, status:resp.status }));
  return j;
}

/* ---------- Materials functions & UI ---------- */
function addMaterialRow(data = {}){
  const id = `m${matIdCounter++}`;
  const tr = document.createElement('tr');
  tr.dataset.matId = id;
  tr.draggable = true;
  tr.innerHTML = `
    <td class="idx">${materialsTbody.children.length + 1}</td>
    <td><input data-key="name" placeholder="名称" value="${escapeHtml(data.name||'')}" /></td>
    <td><input data-key="qty" placeholder="数量" value="${escapeHtml(data.qty||'')}" /></td>
    <td><input data-key="note" placeholder="备注" value="${escapeHtml(data.note||'')}" /></td>
    <td><input data-key="link" placeholder="链接(可选)" value="${escapeHtml(data.link||'')}" /></td>
    <td class="mat-actions"><button class="ghost small del">删除</button></td>
  `;
  materialsTbody.appendChild(tr);
  tr.querySelector('button.del').addEventListener('click', ()=>{ tr.remove(); refreshMaterialIndexes(); });
}
function refreshMaterialIndexes(){ Array.from(materialsTbody.children).forEach((tr, idx)=>{ tr.querySelector('.idx').textContent = (idx+1).toString(); }); }
function ensureFiveRows(){ if(materialsTbody.children.length===0){ for(let i=0;i<5;i++) addMaterialRow(); } }

/* drag/drop handlers */
let dragSrcEl = null;
function matDragStart(e){
  const tr = e.target.closest('tr');
  if(!tr) return;
  dragSrcEl = tr;
  tr.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', tr.dataset.matId || '');
}
function matDragOver(e){
  e.preventDefault();
  const over = e.target.closest('tr');
  if(!over || !dragSrcEl || over === dragSrcEl) return;
  const rect = over.getBoundingClientRect();
  const dy = e.clientY - rect.top;
  const before = dy < rect.height/2;
  const parent = materialsTbody;
  if(before) parent.insertBefore(dragSrcEl, over);
  else parent.insertBefore(dragSrcEl, over.nextSibling);
  refreshMaterialIndexes();
}
function matDrop(e){
  e.preventDefault();
  if(dragSrcEl) dragSrcEl.classList.remove('dragging');
  dragSrcEl = null;
}
function matDragEnd(e){
  if(dragSrcEl) dragSrcEl.classList.remove('dragging');
  dragSrcEl = null;
}

/* save materials via Edge Function */
async function saveMaterials(){
  try {
    if(!editingPatternId) return alert('请先创建或选择纸样');
    const rows = [];
    Array.from(materialsTbody.children).forEach((tr, idx)=>{
      const name = tr.querySelector('input[data-key="name"]').value.trim();
      const qty = tr.querySelector('input[data-key="qty"]').value.trim();
      const note = tr.querySelector('input[data-key="note"]').value.trim();
      const link = tr.querySelector('input[data-key="link"]').value.trim();
      if(!name) return;
      rows.push({ name, qty, note, link });
    });
    if(rows.length === 0) return alert('没有要保存的材料');
    showOverlay('保存材料...');
    const headers = await authHeaders();
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/save-pattern-materials`, {
      method:'POST',
      headers,
      body: JSON.stringify({ pattern_id: editingPatternId, materials: rows })
    });
    const j = await resp.json().catch(()=>({ ok:false, status:resp.status }));
    hideOverlay();
    if(!j || !(j.ok || j.inserted_count >= 0)) return alert('保存失败: ' + (j?.error || JSON.stringify(j)));
    alert('材料保存成功: ' + (j.inserted_count || 0) + ' 行');
    await loadMaterialsForPattern(editingPatternId);
  } catch(e){
    hideOverlay();
    alert('保存失败: ' + (e.message || e));
  }
}

/* load materials for pattern (client-side query) */
async function loadMaterialsForPattern(pid){
  try {
    if(!pid) { materialsTbody.innerHTML=''; ensureFiveRows(); return; }
    const { data, error } = await supabase.from('pattern_materials').select('*').eq('pattern_id', pid).order('seq', { ascending:true });
    if(error){ console.warn('load mats err', error); materialsTbody.innerHTML=''; ensureFiveRows(); return; }
    materialsTbody.innerHTML = '';
    (data||[]).forEach(d => addMaterialRow(d));
    refreshMaterialIndexes();
    if((data||[]).length === 0) ensureFiveRows();
  } catch(e){
    console.warn('loadMaterialsForPattern exception', e);
    materialsTbody.innerHTML=''; ensureFiveRows();
  }
}

/* ---------- Materials Library Modal ---------- */
function openMaterialsModal(){ libModal.style.display = 'block'; fetchMaterialsLibraryAndRender(); }
function closeMaterialsModal(){ libModal.style.display = 'none'; }

async function fetchMaterialsLibraryAndRender(){
  libList.innerHTML = '<div class="muted">加载中...</div>';
  try {
    showOverlay('加载材料库...');
    const headers = await authHeaders();
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/materials-library`, { method:'GET', headers });
    const j = await resp.json().catch(()=>({ ok:false, status:resp.status }));
    hideOverlay();
    if(!j || !j.items) { libList.innerHTML = '<div class="muted">加载失败</div>'; return; }
    localStorage.setItem('materials_library_cache', JSON.stringify(j.items || []));
    renderMaterialsLib(j.items || []);
  } catch(e){
    hideOverlay();
    console.warn('materials library fetch err', e);
    const cache = JSON.parse(localStorage.getItem('materials_library_cache') || '[]');
    renderMaterialsLib(cache || []);
  }
}

function renderMaterialsLib(items){
  libList.innerHTML = '';
  if(!items || items.length===0) { libList.innerHTML = '<div class="muted">暂无历史材料</div>'; return; }
  items.forEach((it, idx)=>{
    const row = document.createElement('div');
    row.className = 'lib-item';
    row.innerHTML = `
      <input type="checkbox" class="lib-cb" data-idx="${idx}" />
      <div style="flex:1">
        <div><strong>${escapeHtml(it.name)}</strong> <span class="muted" style="margin-left:8px">${escapeHtml(it.qty||'')}</span></div>
        <div class="muted" style="font-size:12px">${escapeHtml(it.note||'')} ${it.link? (' • ' + escapeHtml(it.link)) : ''}</div>
      </div>
      <button class="ghost small lib-del" data-idx="${idx}">删除</button>
    `;
    libList.appendChild(row);
    row.querySelector('.lib-del').addEventListener('click', ()=>{
      const cache = JSON.parse(localStorage.getItem('materials_library_cache') || '[]');
      cache.splice(idx,1);
      localStorage.setItem('materials_library_cache', JSON.stringify(cache));
      renderMaterialsLib(cache);
    });
  });
}

function addSelectedLibToMaterials(){
  const cbs = Array.from(libList.querySelectorAll('.lib-cb')).filter(i=>i.checked);
  if(cbs.length===0) return alert('请选择要添加的材料');
  const cache = JSON.parse(localStorage.getItem('materials_library_cache') || '[]');
  cbs.forEach(cb=>{
    const idx = Number(cb.dataset.idx);
    const it = cache[idx];
    if(it) addMaterialRow(it);
  });
  refreshMaterialIndexes();
  closeMaterialsModal();
}

/* ---------- Tutorials ---------- */
function getSelectedTutorialType(){
  const radios = document.querySelectorAll('input[name="tutType"]');
  for(const r of radios) if(r.checked) return r.value;
  return 'text';
}
function onTutorialTypeChange(){
  const sel = getSelectedTutorialType();
  if(sel === 'text' || sel === 'external_link'){
    tutorialLink.style.display = 'block';
    tutorialFile.style.display = 'none';
  } else {
    tutorialLink.style.display = 'none';
    tutorialFile.style.display = 'block';
  }
}

async function onUploadTutorial(){
  try {
    if(!editingPatternId) return alert('请先选择或创建纸样');
    const pid = editingPatternId;
    const type = getSelectedTutorialType();
    const title = (tutorialTitle.value||'').trim();
    let body = (tutorialLink.value||'').trim();
    let media_path = null;

    if(type === 'external_link'){
      if(!body) return alert('请填写外部链接');
      media_path = body;
    } else if(type === 'text'){
      if(!body) return alert('请填写文本内容');
    } else {
      const f = tutorialFile.files[0];
      if(!f) return alert('请选择文件上传');
      if(f.size > MAX_FILE_BYTES) return alert('文件过大');
      showOverlay('上传教程文件...');
      try {
        media_path = await uploadFileViaServerXHR(pid, f, 'patterns-assets', (pct)=>{ /* optional */ });
      } catch(upErr){
        hideOverlay();
        return alert('文件上传失败: ' + (upErr.message || upErr));
      }
      hideOverlay();
    }

    showOverlay('保存教程记录...');
    const row = { pattern_id: pid, seq: 0, media_type: type, title, body: type==='text'?body:null, media_path: media_path || null };
    const { data, error } = await supabase.from('tutorial_media').insert([row]).select();
    hideOverlay();
    if(error) return alert('插入失败: ' + error.message);
    alert('教程保存成功');
    await loadTutorialsForPattern(pid);
  } catch(e){ hideOverlay(); alert('上传教程失败: ' + (e.message || e)); }
}

async function loadTutorialsForPattern(pid){
  try {
    if(!pid) { tutorialsList.innerHTML = '<div class="muted">请先选择纸样</div>'; return; }
    const { data, error } = await supabase.from('tutorial_media').select('*').eq('pattern_id', pid).order('seq', { ascending:true });
    if(error) { tutorialsList.innerHTML = `<div class="muted">加载失败: ${error.message}</div>`; return; }
    if(!data || data.length===0) { tutorialsList.innerHTML = '<div class="muted">暂无教程</div>'; return; }
    tutorialsList.innerHTML = '';
    data.forEach(d=>{
      const el = document.createElement('div'); el.style.marginBottom = '8px';
      const type = escapeHtml(d.media_type || ''); const title = escapeHtml(d.title || ''); const body = escapeHtml(d.body || '');
      let mediaHtml = '';
      if(d.media_path){
        // try to generate a public URL (may need bucket prefix)
        const url = getPublicUrl(d.media_path);
        mediaHtml = `<div><a class="link" target="_blank" href="${url}">打开媒体</a> <span class="muted" style="margin-left:8px">${escapeHtml(d.media_path)}</span></div>`;
      }
      el.innerHTML = `<strong>[${type}] ${title}</strong>
        <div>${body}</div>
        ${mediaHtml}
        <hr/>`;
      tutorialsList.appendChild(el);
    });
  } catch(e){ tutorialsList.innerHTML = `<div class="muted">异常: ${e.message}</div>`; }
}

/* ---------- Utilities ---------- */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

</script>
</body>
</html>
